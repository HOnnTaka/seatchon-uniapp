"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-section")+e.resolveComponent("uni-list-item")+e.resolveComponent("uni-collapse-item")+e.resolveComponent("uni-collapse")+e.resolveComponent("uni-card")+e.resolveComponent("uni-dateformat")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-section/components/uni-section/uni-section.js")+(()=>"../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse-item/uni-collapse-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse/uni-collapse.js")+(()=>"../../uni_modules/uni-card/components/uni-card/uni-card.js")+(()=>"../../uni_modules/uni-dateformat/components/uni-dateformat/uni-dateformat.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const a={__name:"detail",setup(a){const l=getCurrentPages().find((e=>"pages/detail/detail"===e.route)),t=e.ref(null),i=e.ref(null),n=e.ref(),u=e.ref(!1),o=e.ref(e.index.getStorageSync("userinfo")),s=e.ref(!1),v=e.ref(!0),d=e.ref(!1),r=e.ref("将使用以下信息选座：");e.onLoad((async a=>{i.value=a.chartId,await m(a.chartId),d.value=!0,e.index.hideLoading()})),e.onShow((async()=>{o.value=e.index.getStorageSync("userinfo"),await m(i.value)})),e.onReady((()=>{})),e.onPullDownRefresh((async()=>{await m(i.value),e.index.vibrateShort(),e.index.stopPullDownRefresh()}));const c=e.computed((()=>{var e;return null==(e=n.value)?void 0:e.administrators.includes(o.value._id)})),p=e.computed((()=>{var e;return(null==(e=n.value)?void 0:e.administrators[0])==o.value._id})),m=async a=>{u.value=!0;const l=e.Ws.database(),{result:t}=await l.collection("seat-chart").doc(a).get();n.value=t.data[0],e.index.setNavigationBarTitle({title:n.value.title}),await h(),u.value=!1},f=e.ref([]),h=async()=>{var a,l;if(!(null==(a=n.value)?void 0:a.administrators))return"";const t=e.Ws.database(),{result:i}=await t.collection("user").where({_id:t.command.in(n.value.administrators)}).field("nickName").get(),u=null==(l=n.value)?void 0:l.administrators.map((e=>{const a=i.data.find((a=>a._id==e));if(a)return a.nickName}));f.value=u},g=()=>{var e;if(!n.value)return!1;const a=null==(e=n.value)?void 0:e.selectableTimeRange,l=new Date((new Date).toISOString().substring(0,10)).getTime(),t=new Date(a[0]).getTime(),i=new Date(a[1]).getTime();return t<=l&&l<=i},w=async()=>{s.value=!1,$.value={value:"",title:"",placeholder:""}},x=async(a=!0)=>{var l;await m(i.value),a&&e.index.showToast({title:"刷新成功",icon:"success"}),t.value=n.value.seats[(null==(l=t.value)?void 0:l.index)-1]},y=async()=>{var e;v.value=(null==(e=t.value.stuInfo)?void 0:e.id)!=o.value._id,r.value=v.value?"将使用以下信息选座：":"将撤销以下选座：",s.value=!0},T=async()=>{e.index.showLoading({title:"加载中",mask:!0}),u.value=!0;const{result:a}=await e.Ws.callFunction({name:"select-seat",data:{chartId:i.value,seatIndex:t.value.index,userinfo:c.value?$.value:o.value,isSelectSubmit:v.value,orderId:t.value.orderId,edit:c.value}});s.value=!1,200==a.code?e.index.showToast({title:c.value?"修改成功":"选座成功",icon:"success"}):201==a.code?e.index.showToast({title:"撤销成功",icon:"success"}):e.index.showToast({title:a.message,icon:"error"}),x(!1)},b=e.ref({value:"",title:"",placeholder:""}),I=e.ref(!1),_=async()=>{b.value={type:"addAdmin",title:"添加管理员(仅当前课室)",placeholder:"请输入管理员学号/id",value:""},I.value=!0,setTimeout((()=>{l.$vm.$refs.inputDialog.open()}))},L=async()=>{b.value={type:"deleteAdmin",title:"删除管理员(仅当前课室)",placeholder:"请输入管理员学号/id",value:""},I.value=!0,setTimeout((()=>{l.$vm.$refs.inputDialog.open()}))},C=async(e,a)=>{b.value={type:e,title:"编辑"+e,placeholder:"请输入"+e,value:a},I.value=!0,setTimeout((()=>{l.$vm.$refs.inputDialog.open()}))},D={"姓名":"name","班级":"class","学号":"id"},j=async a=>{console.log(b.value);const l=a.trim();if(0===l.length)return void e.index.showToast({title:"内容不能为空",icon:"none"});const{type:t}=b.value;if("addAdmin"==t)return k(l);if("deleteAdmin"==t)return S(l);if("学号"==t){u.value=!0,e.index.showLoading({title:"加载中",mask:!0});const a=e.Ws.database(),{result:i}=await a.collection("user").doc(l).field("_id,name,class").get();if(console.log(i),e.index.hideLoading(),u.value=!1,0==i.data.length)return void e.index.showToast({title:"用户不存在",icon:"none"});$.value[D[t]]=i.data[0]._id,$.value.name=i.data[0].name||"",$.value.class=i.data[0].class||""}else{if(!(await e.index.showModal({title:"提示",content:"单独修改姓名或班级不会同步到相应用户",confirmText:"继续"})).confirm)return;$.value[D[t]]=l}},k=async a=>{e.index.showLoading({title:"加载中",mask:!0}),u.value=!0;const{administrators:l}=n.value;if(l.includes(a))return e.index.showToast({title:"该用户已是管理员",icon:"none"}),void(u.value=!1);const t=e.Ws.database(),{result:o}=await t.collection("user").doc(a).field("_id").get();if(0==o.data.length)return e.index.showToast({title:"用户不存在",icon:"none"}),void(u.value=!1);l.push(a),n.value.administrators=l,await t.collection("seat-chart").doc(i.value).update({administrators:l}),await h(),u.value=!1,e.index.showToast({title:"添加成功",icon:"success"}),I.value=!1},S=async a=>{e.index.showLoading({title:"加载中",mask:!0}),u.value=!0;const{administrators:l}=n.value;if(!l.includes(a))return e.index.showToast({title:"该用户不是管理员",icon:"none"}),void(u.value=!1);if(a==o.value._id)return e.index.showToast({title:"不能删除自己",icon:"none"}),void(u.value=!1);const t=l.indexOf(a);l.splice(t,1);const s=e.Ws.database();await s.collection("seat-chart").doc(i.value).update({administrators:l}),await h(),n.value.administrators=l,e.index.showToast({title:"删除成功",icon:"success"}),u.value=!1,I.value=!1},R=()=>{e.index.navigateTo({url:"/pages/createSeatChart/createSeatChart?type=edit&chartId="+i.value})},W=async()=>{if(!(await e.index.showModal({title:"提示",content:"确定删除该课室吗？"})).confirm)return;e.index.showLoading({title:"加载中",mask:!0});const a=e.Ws.database(),{result:l}=await a.collection("seat-chart").doc(i.value).remove();console.log(l),e.index.showToast({title:"删除成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1e3)},$=e.ref({}),F=async()=>{P(!0)},M=async()=>{P(!1)},P=async e=>{var a,l,i;v.value=e,r.value=e?"将修改以下选座：":"将撤销以下选座：",$.value={id:(null==(a=t.value.stuInfo)?void 0:a.id)||o.value._id,name:(null==(l=t.value.stuInfo)?void 0:l.name)||o.value.name,class:(null==(i=t.value.stuInfo)?void 0:i.class)||o.value.class},s.value=!0},A=a=>{console.log(a),e.index.setClipboardData({data:a,showToast:!0,success:function(){e.index.vibrateShort()}})},B=async()=>{e.index.showLoading({title:"加载中",mask:!0}),u.value=!0,e.Ws.callFunction({name:"exportExcel",data:{chartId:i.value},success:function(a){a.result.fileID&&e.Ws.getTempFileURL({fileList:[a.result.fileID],success:function(a){if(a.fileList.length>0){const l=a.fileList[0].tempFileURL;e.index.downloadFile({url:l,success:async function(a){u.value=!1,e.index.hideLoading(),200===a.statusCode&&(await e.index.showModal({title:"下载成功",content:"打开后使用右上角功能保存",showCancel:!1,confirmText:"确定"}),e.index.openDocument({filePath:a.tempFilePath,showMenu:!0}))}})}}})},fail:function(a){console.error(a),e.index.hideLoading(),u.value=!1}})};return(a,l)=>{var i,d,m,h,D,k,S,P,N,V,O,U,q,E,z,G,H,J,K,Q,X,Y,Z,ee,ae,le,te,ie,ne,ue,oe,se,ve,de;return e.e({a:c.value},(c.value,{}),{b:e.p({title:"课室信息",type:"line"}),c:e.t(null==(i=n.value)?void 0:i.title),d:e.o((e=>{var a;return A(null==(a=n.value)?void 0:a.title)})),e:e.p({title:"课室"}),f:e.t(null==(d=n.value)?void 0:d.note),g:e.o((e=>{var a;return A(null==(a=n.value)?void 0:a.note)})),h:e.p({title:"备注"}),i:e.t(null==(m=n.value)?void 0:m.selectableTimeRange.join(" 至 ")),j:e.o((e=>{var a;return A(null==(a=n.value)?void 0:a.selectableTimeRange.join(" 至 "))})),k:e.p({title:"选座时间"}),l:e.t(null==(h=n.value)?void 0:h.effectiveTimeRange.join(" 至 ")),m:e.o((e=>{var a;return A(null==(a=n.value)?void 0:a.effectiveTimeRange.join(" 至 "))})),n:e.p({title:"生效时间"}),o:c.value},c.value?e.e({p:e.o(R),q:u.value,r:p.value},p.value?{s:e.o(W),t:u.value}:{}):{},{v:c.value},c.value?{w:e.o(B),x:u.value}:{},{y:e.p({open:null!=n.value&&!u.value,titleBorder:"none"}),z:e.p({padding:"0"}),A:e.p({title:"课室管理员",type:"line"}),B:e.f(null==(D=n.value)?void 0:D.administrators,((a,l,t)=>e.e({a:0==l},{},{b:e.t(a),c:e.o((e=>A(a)),l),d:l,e:"e40bfa9f-12-"+t+",e40bfa9f-10",f:e.p({ellipsis:"1",title:f.value[l]})}))),C:p.value},p.value?{D:e.o(_),E:u.value,F:e.o(L),G:u.value}:{},{H:e.p({open:null!=n.value&&!u.value,titleBorder:"none"}),I:e.p({padding:"0"}),J:e.p({title:"座位表",type:"line"}),K:e.f(null==(k=n.value)?void 0:k.seats,((a,l,i)=>{var n,u,s,v;return{a:e.t(a.stuInfo?(null==(n=null==a?void 0:a.stuInfo)?void 0:n.id)!=o.value._id?"":"你":"空"),b:l,c:2==a.status?1:"",d:a.index==(null==(u=t.value)?void 0:u.index)?1:"",e:e.s((null==(s=null==a?void 0:a.stuInfo)?void 0:s.id)!=o.value._id?`background-image:url(${null==(v=a.stuInfo)?void 0:v.avatar});`:"background:#333;"),f:e.o((()=>t.value=a),l)}})),L:e.s(`--col:${null==(S=n.value)?void 0:S.col};--row:${null==(P=n.value)?void 0:P.row};`),M:e.o(x),N:u.value,O:e.p({padding:"0"}),P:t.value},t.value?e.e({Q:e.p({title:"座位信息",type:"line"}),R:e.t(null==(N=t.value)?void 0:N.x),S:e.t(null==(V=t.value)?void 0:V.y),T:e.p({title:"座位"}),U:(null==(O=t.value)?void 0:O.stuInfo)&&(n.value.stuInfoVisible||1==o.value.type)},(null==(U=t.value)?void 0:U.stuInfo)&&(n.value.stuInfoVisible||1==o.value.type)?{V:e.t(null==(E=null==(q=t.value)?void 0:q.stuInfo)?void 0:E.name),W:e.p({title:"姓名"}),X:e.t(null==(G=null==(z=t.value)?void 0:z.stuInfo)?void 0:G.id),Y:e.p({title:"学号"}),Z:e.t(null==(J=null==(H=t.value)?void 0:H.stuInfo)?void 0:J.class),aa:e.p({title:"班级"})}:{},{ab:null==(K=t.value)?void 0:K.selectTime},(null==(Q=t.value)?void 0:Q.selectTime)?{ac:e.p({date:new Date(null==(X=t.value)?void 0:X.selectTime)-3e4,format:"M月d日 h时m分",threshold:[0,36e5]}),ad:e.p({title:"选择时间"})}:{},{ae:e.p({padding:"0"})}):{},{af:c.value},c.value?{ag:!t.value,ah:e.o(F),ai:u.value,aj:3!=(null==(Y=t.value)?void 0:Y.status),ak:e.o(M),al:u.value}:e.e({am:g()},g()?{an:e.t((null==(ee=null==(Z=t.value)?void 0:Z.stuInfo)?void 0:ee.id)==o.value._id?"撤销选座":3==(null==(ae=t.value)?void 0:ae.status)?"已被选择":"选择座位"),ao:e.o(y),ap:3==(null==(le=t.value)?void 0:le.status)&&(null==(ie=null==(te=t.value)?void 0:te.stuInfo)?void 0:ie.id)!=o.value._id||!t.value,aq:(null==(ue=null==(ne=t.value)?void 0:ne.stuInfo)?void 0:ue.id)==o.value._id?"warn":"primary",ar:u.value}:{},{as:!g()},(g(),{})),{at:e.t(r.value),av:e.p({title:"课室信息",type:"line"}),aw:e.t(null==(oe=n.value)?void 0:oe.title),ax:e.p({title:"课室"}),ay:e.t(null==(se=t.value)?void 0:se.x),az:e.t(null==(ve=t.value)?void 0:ve.y),aA:e.p({title:"座位"}),aB:e.t(null==(de=n.value)?void 0:de.effectiveTimeRange.join(" 至 ")),aC:e.p({title:"生效时间"}),aD:e.p({title:"学生信息",type:"line"}),aE:e.t(c.value?$.value.id:o.value._id),aF:e.o((e=>C("学号",$.value.id))),aG:e.p({title:"学号",link:c.value&&v.value}),aH:e.t(c.value?$.value.name:o.value.name),aI:e.o((e=>C("姓名",$.value.name))),aJ:e.p({title:"姓名",link:c.value&&v.value}),aK:e.t(c.value?$.value.class:o.value.class),aL:e.o((e=>C("班级",$.value.class))),aM:e.p({title:"班级",link:c.value&&v.value}),aN:e.p({padding:"0"}),aO:e.o(T),aP:v.value?"primary":"warn",aQ:u.value,aR:e.o((()=>{})),aS:e.o(w),aT:s.value?"":1,aU:I.value},I.value?{aV:e.sr("inputClose","e40bfa9f-34,e40bfa9f-33"),aW:e.o(j),aX:e.o((e=>I.value=!1)),aY:e.o((e=>b.value.value=e)),aZ:e.p({mode:"input",title:b.value.title,placeholder:b.value.placeholder,modelValue:b.value.value}),ba:e.sr("inputDialog","e40bfa9f-33"),bb:e.p({type:"dialog"})}:{},{bc:e.s(null!=n.value?"transition: all .5s ease; opacity: 1":"")})}}},l=e._export_sfc(a,[["__scopeId","data-v-e40bfa9f"]]);wx.createPage(l);
