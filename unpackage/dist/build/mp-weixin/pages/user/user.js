"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-section")+e.resolveComponent("uni-list-item")+e.resolveComponent("uni-list")+e.resolveComponent("uni-card")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-forms")+e.resolveComponent("uni-collapse-item")+e.resolveComponent("uni-collapse")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-section/components/uni-section/uni-section.js")+(()=>"../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../uni_modules/uni-list/components/uni-list/uni-list.js")+(()=>"../../uni_modules/uni-card/components/uni-card/uni-card.js")+(()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse-item/uni-collapse-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse/uni-collapse.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const a={__name:"user",setup(a){const o=getCurrentPages().find((e=>"pages/user/user"===e.route)),l=e.ref(e.index.getStorageSync("userinfo")),n=e.ref(!1);e.onShow((async()=>{setTimeout((()=>{n.value=!0}),100)})),e.onHide((async()=>{n.value=!1}));const i=e.ref({id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""}),u=e.ref({id:"",name:""});e.onLoad((()=>{}));const t={id:{rules:[{required:!0,errorMessage:"请输入账号/学号"}]},pwd:{rules:[{required:!0,errorMessage:"请输入密码"}]},adminpwd:{rules:[{required:!0,errorMessage:"请输入管理密码"}]},newpwd:{rules:[{required:!0,errorMessage:"请输入新密码"},{validateFunction:function(e,a,o,l){/^[a-zA-Z0-9]{8,20}$/.test(a)||l("密码必须为8-20位字母、数字")}}]},newpwd2:{rules:[{required:!0,errorMessage:"请确认新密码"},{validateFunction:function(e,a,o,l){a!=i.value.newpwd&&l("两次密码输入不一致")}}]}},s={name:{rules:[{required:!0,errorMessage:"请输入姓名"}]}};e.onReady((async()=>{var e,a,l,n;null==(e=o.$vm.$refs.form)||e.setRules(t),null==(a=o.$vm.$refs.form1)||a.setRules(t),null==(l=o.$vm.$refs.adminform)||l.setRules(t),null==(n=o.$vm.$refs.addStudentForm)||n.setRules(s)}));const d=async a=>{e.index.showLoading({title:"加载中",mask:!0});try{let u=await o.$vm.$refs[a].validate();if("adminform"==a){try{const{code:a}=await e.index.login(),{result:o}=await e.Ws.callFunction({name:"login",data:{adminpwd:u.adminpwd,code:a}});console.log(o),e.index.showToast({title:o.message,icon:1==o.code?"error":"success"}),0==o.code&&(e.index.setStorageSync("userinfo",o.userinfo),e.index.reLaunch({url:"/pages/user/user"}))}catch(n){e.index.showToast({title:"请使用微信小程序打开",icon:"none",duration:2e3})}return}l.value&&(u.id=l.value._id);try{console.log(u,l.value);const{result:a}=await e.Ws.callFunction({name:"login",data:u});console.log(a),e.index.showToast({title:a.message,icon:1==a.code?"error":"success"}),1!=a.code&&(3!=a.code&&(e.index.setStorageSync("userinfo",a.userinfo),l.value=a.userinfo,e.index.reLaunch({url:"/pages/user/user"}),2==a.code&&e.index.showToast({title:"请尽快修改默认密码",icon:"none",duration:4e3})),i.value={id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""})}catch(n){console.log(n),e.index.showToast({title:n.message,icon:"none",duration:2e3})}}catch(n){return console.log(n),void e.index.showToast({title:"请检查输入内容",icon:"none",duration:2e3})}e.index.hideLoading()},r=()=>{e.index.setStorageSync("userinfo",""),l.value="",e.index.showToast({title:"退出登录成功",icon:"success"})},p=e.ref({value:"",title:"",placeholder:""}),c={"昵称":"nickName"},m=async a=>{const n=a.trim();if(0===n.length)return void e.index.showToast({title:"内容不能为空",icon:"none"});const{type:i}=p.value,{result:u}=await e.Ws.database().collection("user").doc(l.value._id).update({[`${c[i]}`]:n});if(0==u.errCode)return"昵称"==i?l.value.nickName=n:l.value.stuInfo[c[i].replace("stuInfo.","")]=n,e.index.setStorageSync("userinfo",l.value),p.value={},e.index.showToast({title:"修改成功",icon:"success"}),g.value=!0,void o.$vm.$refs.inputDialog.close();e.index.showToast({title:"修改失败",icon:"none"})},v=e.ref(0),w=async()=>{if(v.value++,console.log(v.value),v.value>=5){console.log(l.value.type);const{result:a}=await e.Ws.database().collection("user").doc(l.value._id).update({type:0==l.value.type?1:0});console.log(a),0==a.errCode&&(l.value.type=0==l.value.type?1:0,e.index.setStorageSync("userinfo",l.value),e.index.reLaunch({url:"/pages/index/index"}))}},f=async a=>{const o=a.detail.avatarUrl;e.index.showLoading({title:"上传中",mask:!0});try{const{fileID:a}=await e.Ws.uploadFile({filePath:o,cloudPath:"avatar/"+l.value._id+".png",fileType:"image"}),{fileList:n}=await e.Ws.getTempFileURL({fileList:[a]}),{result:i}=await e.Ws.database().collection("user").doc(l.value._id).update({avatarUrl:n[0].tempFileURL});if(i.updated>0)return l.value.avatarUrl=n[0].tempFileURL,e.index.setStorageSync("userinfo",l.value),void e.index.showToast({title:"上传成功",icon:"success"})}catch(n){console.log(n)}e.index.showToast({title:"上传失败",icon:"none"})},g=e.ref(!1),y=e.ref(null);return(a,t)=>e.e({a:l.value},l.value?{b:e.p({title:"我的信息",type:"line"}),c:l.value.avatarUrl,d:e.p({border:!1,clickable:!0,showArrow:!0}),e:e.o(w),f:e.o(f),g:e.t(l.value.nickName),h:e.o((e=>(async(e,a)=>{p.value={type:e,title:"编辑"+e,placeholder:"请输入"+e,value:a},g.value=!0,setTimeout((()=>{o.$vm.$refs.inputDialog.open()}))})("昵称",l.value.nickName))),i:e.p({clickable:!0,showArrow:!0,title:"昵称"}),j:e.t(l.value.name),k:e.p({title:"姓名"}),l:e.t(l.value._id),m:e.p({title:1==l.value.type?"学号/id":"学号"}),n:e.t(l.value.class),o:e.p({title:"班级"}),p:e.p({padding:"0"})}:{},{q:!l.value},l.value?{}:{r:e.p({title:"登录",type:"line"}),s:e.o((e=>i.value.id=e)),t:e.p({placeholder:"请输入账号/学号",modelValue:i.value.id}),v:e.p({label:"账号",required:!0,name:"id"}),w:e.o((e=>i.value.pwd=e)),x:e.p({type:"password",placeholder:"请输入密码",modelValue:i.value.pwd}),y:e.p({label:"密码",required:!0,name:"pwd"}),z:e.sr("form","3cf01770-10,3cf01770-8"),A:e.p({modelValue:i.value}),B:e.o((e=>d("form"))),C:e.p({padding:"0"})},{D:!l.value},l.value?{}:{E:e.p({title:"管理员登录",type:"line"}),F:e.o((e=>i.value.adminpwd=e)),G:e.p({placeholder:"请输入管理密码",modelValue:i.value.adminpwd}),H:e.p({name:"adminpwd"}),I:e.sr("adminform","3cf01770-17,3cf01770-15"),J:e.p({modelValue:i.value}),K:e.o((e=>d("adminform"))),L:e.p({padding:"0"})},{M:l.value},l.value?{N:e.p({title:"修改密码",type:"line"}),O:e.o((e=>i.value.pwd=e)),P:e.p({type:"password",placeholder:"请输入密码",modelValue:i.value.pwd}),Q:e.p({label:"旧密码",required:!0,name:"pwd"}),R:e.o((e=>i.value.newpwd=e)),S:e.p({type:"password",placeholder:"请输入新密码",modelValue:i.value.newpwd}),T:e.p({label:"新密码",required:!0,name:"newpwd"}),U:e.o((e=>i.value.newpwd2=e)),V:e.p({type:"password",placeholder:"请确认新密码",modelValue:i.value.newpwd2}),W:e.p({label:"确认密码",required:!0,name:"newpwd2"}),X:e.sr("form1","3cf01770-24,3cf01770-22"),Y:e.p({modelValue:i.value,"label-width":"80px"}),Z:e.o((e=>d("form1"))),aa:e.p({padding:"0"})}:{},{ab:l.value},l.value?{ac:e.p({title:"添加学生（管理员）",type:"line"}),ad:e.o((e=>u.value.id=e)),ae:e.p({placeholder:"输入学号/id（留空自动生成id）",modelValue:u.value.id}),af:e.p({label:"学号/id",name:"pwd"}),ag:e.o((e=>u.value.name=e)),ah:e.p({placeholder:"请输入姓名",modelValue:u.value.name}),ai:e.p({label:"姓名",required:!0,name:"newpwd"}),aj:e.sr("addStudentForm","3cf01770-35,3cf01770-33"),ak:e.p({modelValue:u.value,"label-width":"80px"}),al:e.o(((...e)=>a.addStudentFormSubmit&&a.addStudentFormSubmit(...e))),am:e.p({padding:"0"})}:{},{an:l.value},l.value?{ao:e.p({title:"批量添加学生（管理员）",type:"line"}),ap:e.o((e=>d("form1"))),aq:e.p({padding:"0"})}:{},{ar:g.value},g.value?{as:e.sr("inputClose","3cf01770-45,3cf01770-44"),at:e.o(m),av:e.o((e=>g.value=!1)),aw:e.o((e=>p.value.value=e)),ax:e.p({mode:"input",title:p.value.title,placeholder:p.value.placeholder,modelValue:p.value.value}),ay:e.sr(y,"3cf01770-44",{k:"inputDialog"}),az:e.p({type:"dialog"})}:{},{aA:l.value},l.value?{aB:e.o(r)}:{},{aC:e.s(n.value?"transition: all .5s ease; opacity: 1":"")})}},o=e._export_sfc(a,[["__scopeId","data-v-3cf01770"]]);wx.createPage(o);
