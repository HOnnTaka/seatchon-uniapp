"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-section")+e.resolveComponent("uni-list-item")+e.resolveComponent("uni-collapse-item")+e.resolveComponent("uni-collapse")+e.resolveComponent("uni-card")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-forms")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-section/components/uni-section/uni-section.js")+(()=>"../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse-item/uni-collapse-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse/uni-collapse.js")+(()=>"../../uni_modules/uni-card/components/uni-card/uni-card.js")+(()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const a={__name:"user",setup(a){const o=getCurrentPages().find((e=>"pages/user/user"===e.route)),l=e.ref(e.index.getStorageSync("userinfo")),i=e.ref(!1),n=e.ref(!1);e.onShow((async()=>{setTimeout((()=>{i.value=!0}),100)})),e.onHide((async()=>{i.value=!1}));const t=a=>{console.log(a),e.index.setClipboardData({data:a,showToast:!0,success:function(){e.index.vibrateShort()}})},s=e.ref({id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""}),u=e.ref({id:"",name:"",class:""}),d=e.ref({id:""});e.onLoad((()=>{}));const r={id:{rules:[{required:!0,errorMessage:"请输入学号/id"}]},pwd:{rules:[{required:!0,errorMessage:"请输入密码"}]},adminpwd:{rules:[{required:!0,errorMessage:"请输入管理密码"}]},newpwd:{rules:[{required:!0,errorMessage:"请输入新密码"},{validateFunction:function(e,a,o,l){/^[a-zA-Z0-9]{8,20}$/.test(a)||l("密码必须为8-20位字母、数字")}}]},newpwd2:{rules:[{required:!0,errorMessage:"请确认新密码"},{validateFunction:function(e,a,o,l){a!=s.value.newpwd&&l("两次密码输入不一致")}}]}},p={name:{rules:[{required:!0,errorMessage:"请输入姓名"}]},class:{rules:[{required:!0,errorMessage:"请输入班级"}]}};e.onReady((async()=>{var e,a,l,i,n;null==(e=o.$vm.$refs.form)||e.setRules(r),null==(a=o.$vm.$refs.form1)||a.setRules(r),null==(l=o.$vm.$refs.adminform)||l.setRules(r),null==(i=o.$vm.$refs.addStudentForm)||i.setRules(p),null==(n=o.$vm.$refs.resetPwdForm)||n.setRules(r)}));const c=async a=>{e.index.showLoading({title:"加载中",mask:!0}),n.value=!0;try{let t=await o.$vm.$refs[a].validate();if("adminform"==a){try{const{code:a}=await e.index.login(),{result:o}=await e.Ws.callFunction({name:"login",data:{adminpwd:t.adminpwd,code:a}});console.log(o),e.index.showToast({title:o.message,icon:1==o.code?"error":"success"}),0==o.code&&(e.index.setStorageSync("userinfo",o.userinfo),e.index.reLaunch({url:"/pages/user/user"}))}catch(i){e.index.showToast({title:"请使用微信小程序打开",icon:"none",duration:2e3}),n.value=!1}return}l.value&&(t.id=l.value._id);try{console.log(t,l.value);const{result:a}=await e.Ws.callFunction({name:"login",data:t});console.log(a),e.index.showToast({title:a.message,icon:1==a.code?"error":"success"}),1!=a.code&&(3!=a.code&&(e.index.setStorageSync("userinfo",a.userinfo),l.value=a.userinfo,e.index.reLaunch({url:"/pages/user/user"}),2==a.code&&e.index.showToast({title:"请尽快修改默认密码",icon:"none",duration:4e3})),s.value={id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""})}catch(i){console.log(i),e.index.showToast({title:i.message,icon:"none",duration:2e3}),n.value=!1}}catch(i){return console.log(i),e.index.showToast({title:i[0].errorMessage,icon:"error",duration:2e3}),void(n.value=!1)}n.value=!1,e.index.hideLoading()},v=()=>{n.value=!0,e.index.setStorageSync("userinfo",""),l.value="",e.index.showToast({title:"退出登录成功",icon:"success"}),n.value=!1},m=e.ref({value:"",title:"",placeholder:""}),w={"昵称":"nickName"},f=async a=>{const i=a.trim();if(0===i.length)return void e.index.showToast({title:"内容不能为空",icon:"none"});const{type:n}=m.value,{result:t}=await e.Ws.database().collection("user").doc(l.value._id).update({[`${w[n]}`]:i});if(0==t.errCode)return"昵称"==n?l.value.nickName=i:l.value.stuInfo[w[n].replace("stuInfo.","")]=i,e.index.setStorageSync("userinfo",l.value),m.value={},e.index.showToast({title:"修改成功",icon:"success"}),b.value=!0,void o.$vm.$refs.inputDialog.close();e.index.showToast({title:"修改失败",icon:"none"})},g=e.ref(0),h=async()=>{if(g.value++,console.log(g.value),g.value>=5){console.log(l.value.type);const{result:a}=await e.Ws.database().collection("user").doc(l.value._id).update({type:0==l.value.type?1:0});console.log(a),0==a.errCode&&(l.value.type=0==l.value.type?1:0,e.index.setStorageSync("userinfo",l.value),e.index.reLaunch({url:"/pages/index/index"}))}},y=async a=>{const o=a.detail.avatarUrl;e.index.showLoading({title:"上传中",mask:!0}),n.value=!0;try{const{fileID:a}=await e.Ws.uploadFile({filePath:o,cloudPath:"avatar/"+l.value._id+".png",fileType:"image"}),{fileList:i}=await e.Ws.getTempFileURL({fileList:[a]}),{result:t}=await e.Ws.database().collection("user").doc(l.value._id).update({avatarUrl:i[0].tempFileURL});if(t.updated>0)return l.value.avatarUrl=i[0].tempFileURL,e.index.setStorageSync("userinfo",l.value),e.index.showToast({title:"上传成功",icon:"success"}),void(n.value=!1)}catch(i){console.log(i)}n.value=!1,e.index.showToast({title:"上传失败",icon:"none"})},b=e.ref(!1),x=async a=>{e.index.showLoading({title:"加载中",mask:!0}),n.value=!0;try{let a=await o.$vm.$refs.addStudentForm.validate();""!=a.id&&(a._id=a.id),delete a.id,console.log(a);const l=e.Ws.database(),{result:i}=await l.collection("user").doc(a._id).field("_id").get();if(i.data.length>0)return e.index.showToast({title:"该id已存在",icon:"none"}),void(n.value=!1);const{result:t}=await l.collection("user").add({...a,avatarUrl:a._id?`https://api.multiavatar.com/${a._id}.png`:"",pwd:"$2a$10$WOW5NsssssCKafZZNDt9PO54RS1ZgoulTWhPl/1c5TTTnUI/w34Pq",type:0});if(console.log(t.id),t.id){if(!a._id){const{result:e}=await l.collection("user").doc(t._id).update({avatarUrl:`https://api.multiavatar.com/${t.id}.png`})}const o=await e.index.showModal({title:"添加成功",content:"id:"+t.id,showCancel:!0,confirmText:"复制"});u.value={},o.confirm&&e.index.setClipboardData({data:t._id,showToast:!0})}}catch(l){console.log(l),e.index.showToast({title:l[0].errorMessage,icon:"none"})}n.value=!1,e.index.hideLoading()},T=async a=>{e.index.showLoading({title:"加载中",mask:!0}),n.value=!0;try{let a=await o.$vm.$refs.resetPwdForm.validate();console.log(a);const l=e.Ws.database(),{result:i}=await l.collection("user").doc(a.id).update({pwd:"$2a$10$WOW5NsssssCKafZZNDt9PO54RS1ZgoulTWhPl/1c5TTTnUI/w34Pq"});if(i.updated>0)return e.index.showToast({title:"重置成功",icon:"success"}),void(n.value=!1)}catch(l){console.log(l),e.index.showToast({title:l[0].errorMessage,icon:"none"})}n.value=!1,e.index.hideLoading()};return(a,r)=>e.e({a:l.value},l.value?{b:e.p({title:"我的信息",type:"line"}),c:l.value.avatarUrl,d:e.p({clickable:!0,showArrow:!0}),e:e.o(h),f:e.o(y),g:e.t(l.value.nickName),h:e.o((e=>(async(e,a)=>{m.value={type:e,title:"编辑"+e,placeholder:"请输入"+e,value:a},b.value=!0,setTimeout((()=>{o.$vm.$refs.inputDialog.open()}))})("昵称",l.value.nickName))),i:e.p({clickable:!0,showArrow:!0,title:"昵称"}),j:e.t(l.value.name),k:e.o((e=>t(l.value.name))),l:e.p({title:"姓名"}),m:e.t(l.value._id),n:e.o((e=>t(l.value._id))),o:e.p({title:1==l.value.type?"学号/id":"学号"}),p:e.t(l.value.class),q:e.p({title:"班级"}),r:e.p({open:i.value,titleBorder:"none"}),s:e.p({padding:"0"})}:{},{t:!l.value},l.value?{}:{v:e.p({title:"登录",type:"line"}),w:e.o((e=>s.value.id=e)),x:e.p({placeholder:"请输入账号/学号",modelValue:s.value.id}),y:e.p({label:"账号",required:!0,name:"id"}),z:e.o((e=>s.value.pwd=e)),A:e.p({type:"password",placeholder:"请输入密码",modelValue:s.value.pwd}),B:e.p({label:"密码",required:!0,name:"pwd"}),C:e.sr("form","8dfcb840-11,8dfcb840-9"),D:e.p({modelValue:s.value}),E:n.value,F:e.o((e=>c("form"))),G:e.p({padding:"0"})},{H:!l.value},l.value?{}:{I:e.p({title:"管理员登录",type:"line"}),J:e.o((e=>s.value.adminpwd=e)),K:e.p({placeholder:"请输入管理密码",modelValue:s.value.adminpwd}),L:e.p({name:"adminpwd"}),M:e.sr("adminform","8dfcb840-18,8dfcb840-16"),N:e.p({modelValue:s.value}),O:n.value,P:e.o((e=>c("adminform"))),Q:e.p({padding:"0"})},{R:l.value},l.value?{S:e.p({title:"修改密码",type:"line"}),T:e.o((e=>s.value.pwd=e)),U:e.p({trim:"both",type:"password",placeholder:"请输入密码",modelValue:s.value.pwd}),V:e.p({label:"旧密码",required:!0,name:"pwd"}),W:e.o((e=>s.value.newpwd=e)),X:e.p({trim:"both",type:"password",placeholder:"请输入新密码",modelValue:s.value.newpwd}),Y:e.p({label:"新密码",required:!0,name:"newpwd"}),Z:e.o((e=>s.value.newpwd2=e)),aa:e.p({trim:"both",type:"password",placeholder:"请确认新密码",modelValue:s.value.newpwd2}),ab:e.p({label:"确认密码",required:!0,name:"newpwd2"}),ac:e.sr("form1","8dfcb840-25,8dfcb840-23"),ad:e.p({modelValue:s.value,"label-width":"80px"}),ae:n.value,af:e.o((e=>c("form1"))),ag:e.p({titleBorder:"none"}),ah:e.p({padding:"0"})}:{},{ai:1==l.value.type},1==l.value.type?{aj:e.p({title:"添加学生（管理员）",type:"line"}),ak:e.o((e=>u.value.id=e)),al:e.p({trim:"both",placeholder:"输入学号/id（留空自动生成id）",modelValue:u.value.id}),am:e.p({label:"学号/id",name:"id"}),an:e.o((e=>u.value.name=e)),ao:e.p({trim:"both",placeholder:"请输入姓名",modelValue:u.value.name}),ap:e.p({label:"姓名",required:!0,name:"name"}),aq:e.o((e=>u.value.class=e)),ar:e.p({trim:"both",placeholder:"请输入班级",modelValue:u.value.class}),as:e.p({label:"班级",required:!0,name:"class"}),at:e.sr("addStudentForm","8dfcb840-36,8dfcb840-34"),av:e.p({modelValue:u.value,"label-width":"80px"}),aw:n.value,ax:e.o(x),ay:e.p({titleBorder:"none"}),az:e.p({padding:"0"})}:{},{aA:1==l.value.type},1==l.value.type?{aB:e.p({title:"重置密码（管理员）",type:"line"}),aC:e.o((e=>d.value.id=e)),aD:e.p({trim:"both",placeholder:"输入学号/id",modelValue:d.value.id}),aE:e.p({required:!0,label:"学号/id",name:"id"}),aF:e.sr("resetPwdForm","8dfcb840-47,8dfcb840-45"),aG:e.p({modelValue:d.value,"label-width":"80px"}),aH:n.value,aI:e.o(T),aJ:e.p({titleBorder:"none"}),aK:e.p({padding:"0"})}:{},{aL:1==l.value.type},1==l.value.type?{aM:e.p({title:"批量添加学生（管理员）",type:"line"}),aN:n.value,aO:e.o((e=>c("form1"))),aP:e.p({titleBorder:"none"}),aQ:e.p({padding:"0"})}:{},{aR:b.value},b.value?{aS:e.sr("inputClose","8dfcb840-55,8dfcb840-54"),aT:e.o(f),aU:e.o((e=>b.value=!1)),aV:e.o((e=>m.value.value=e)),aW:e.p({mode:"input",title:m.value.title,placeholder:m.value.placeholder,modelValue:m.value.value}),aX:e.sr("inputDialog","8dfcb840-54"),aY:e.p({type:"dialog"})}:{},{aZ:l.value},l.value?{ba:n.value,bb:e.o(v)}:{},{bc:e.s(i.value?"transition: all .5s ease; opacity: 1":"")})}},o=e._export_sfc(a,[["__scopeId","data-v-8dfcb840"]]);wx.createPage(o);
