"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-section")+e.resolveComponent("uni-list-item")+e.resolveComponent("uni-collapse-item")+e.resolveComponent("uni-collapse")+e.resolveComponent("uni-card")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-forms")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-section/components/uni-section/uni-section.js")+(()=>"../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse-item/uni-collapse-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse/uni-collapse.js")+(()=>"../../uni_modules/uni-card/components/uni-card/uni-card.js")+(()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const a={__name:"user",setup(a){const o=getCurrentPages().find((e=>"pages/user/user"===e.route)),l=e.ref(e.index.getStorageSync("userinfo")),i=e.ref(!1),n=e.ref(!1);e.onShow((async()=>{setTimeout((()=>{i.value=!0}),100)})),e.onHide((async()=>{i.value=!1}));const t=a=>{console.log(a),e.index.setClipboardData({data:a,showToast:!0,success:function(){e.index.vibrateShort()}})},s=e.ref({id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""}),u=e.ref({id:"",name:"",class:""}),d=e.ref({id:""});e.onLoad((()=>{}));const r={id:{rules:[{required:!0,errorMessage:"请输入学号/id"}]},pwd:{rules:[{required:!0,errorMessage:"请输入密码"}]},adminpwd:{rules:[{required:!0,errorMessage:"请输入管理密码"}]},newpwd:{rules:[{required:!0,errorMessage:"请输入新密码"},{validateFunction:function(e,a,o,l){/^[a-zA-Z0-9]{8,20}$/.test(a)||l("密码必须为8-20位字母、数字")}}]},newpwd2:{rules:[{required:!0,errorMessage:"请确认新密码"},{validateFunction:function(e,a,o,l){a!=s.value.newpwd&&l("两次密码输入不一致")}}]}},p={name:{rules:[{required:!0,errorMessage:"请输入姓名"}]},class:{rules:[{required:!0,errorMessage:"请输入班级"}]}};e.onReady((async()=>{var e,a,l,i,n;null==(e=o.$vm.$refs.form)||e.setRules(r),null==(a=o.$vm.$refs.form1)||a.setRules(r),null==(l=o.$vm.$refs.adminform)||l.setRules(r),null==(i=o.$vm.$refs.addStudentForm)||i.setRules(p),null==(n=o.$vm.$refs.resetPwdForm)||n.setRules(r)}));const c=async a=>{e.index.showLoading({title:"加载中",mask:!0}),n.value=!0;try{let u=await o.$vm.$refs[a].validate();if("adminform"==a){try{const{code:a}=await e.index.login(),{result:o}=await e.Ws.callFunction({name:"login",data:{adminpwd:u.adminpwd,code:a}});e.index.hideLoading(),console.log(o),e.index.showToast({title:o.message,icon:1==o.code?"error":"success"}),0==o.code&&(e.index.setStorageSync("userinfo",o.userinfo),e.index.reLaunch({url:"/pages/user/user"}))}catch(t){e.index.showToast({title:"请使用微信小程序打开",icon:"none",duration:2e3}),n.value=!1}return}l.value&&(u.id=l.value._id);try{console.log(u,l.value);const{result:a}=await e.Ws.callFunction({name:"login",data:u});e.index.hideLoading(),console.log(a),e.index.showToast({title:a.message,icon:1==a.code?"error":"success"}),1!=a.code&&(3!=a.code&&(console.log(a.userinfo),l.value=a.userinfo,e.index.setStorageSync("userinfo",a.userinfo),e.index.setStorageSync("token",a.token),e.index.switchTab({url:"/pages/user/user"}),setTimeout((()=>{i.value=!0})),2==a.code&&e.index.showToast({title:"请尽快修改默认密码",icon:"none",duration:4e3})),s.value={id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""})}catch(t){console.log(t),e.index.showToast({title:t.message,icon:"none",duration:2e3}),n.value=!1}}catch(t){return console.log(t),e.index.showToast({title:t[0].errorMessage,icon:"error",duration:2e3}),e.index.hideLoading(),void(n.value=!1)}n.value=!1},v=async()=>{n.value=!0;const a=await e.Ws.callFunction({name:"logout"});console.log(a),a&&(e.index.setStorageSync("userinfo",""),l.value="",e.index.showToast({title:"退出登录成功",icon:"success"}),n.value=!1)},m=e.ref({value:"",title:"",placeholder:""}),w=async(e,a)=>{m.value={type:e,title:"编辑"+e,placeholder:"请输入"+e,value:a},b.value=!0,setTimeout((()=>{o.$vm.$refs.inputDialog.open()}))},g={"昵称":"nickName","姓名":"name","班级":"class"},h=async a=>{const i=a.trim();if(0===i.length)return void e.index.showToast({title:"内容不能为空",icon:"none"});const{type:n}=m.value,{result:t}=await e.Ws.database().collection("user").doc(l.value._id).update({[`${g[n]}`]:i});if(0==t.errCode)return"昵称"==n?l.value.nickName=i:l.value[g[n].replace("stuInfo.","")]=i,e.index.setStorageSync("userinfo",l.value),m.value={},e.index.showToast({title:"修改成功",icon:"success"}),b.value=!0,void o.$vm.$refs.inputDialog.close();e.index.showToast({title:"修改失败",icon:"none"})},f=e.ref(0),y=async()=>{if(f.value++,console.log(f.value),f.value>=5){console.log(l.value.type);const{result:a}=await e.Ws.database().collection("user").doc(l.value._id).update({type:0==l.value.type?1:0});console.log(a),0==a.errCode&&(l.value.type=0==l.value.type?1:0,e.index.setStorageSync("userinfo",l.value),e.index.reLaunch({url:"/pages/index/index"}))}},x=async a=>{const o=a.detail.avatarUrl;e.index.showLoading({title:"上传中",mask:!0}),n.value=!0;try{const{fileID:a}=await e.Ws.uploadFile({filePath:o,cloudPath:"avatar/"+l.value._id+".png",fileType:"image"}),{fileList:i}=await e.Ws.getTempFileURL({fileList:[a]}),{result:t}=await e.Ws.database().collection("user").doc(l.value._id).update({avatarUrl:i[0].tempFileURL});if(t.updated>0)return l.value.avatarUrl=i[0].tempFileURL,e.index.setStorageSync("userinfo",l.value),e.index.showToast({title:"上传成功",icon:"success"}),void(n.value=!1)}catch(i){console.log(i)}n.value=!1,e.index.showToast({title:"上传失败",icon:"none"})},b=e.ref(!1),T=async(a=0)=>{e.index.showLoading({title:"加载中",mask:!0}),n.value=!0;try{let l=0==a?await o.$vm.$refs.addStudentForm.validate():await o.$vm.$refs.addAdminForm.validate();""!=l.id&&(l._id=l.id),delete l.id,console.log(l);const i=e.Ws.database(),{result:t}=await i.collection("user").doc(l._id).field("_id").get();if(t.data.length>0)return e.index.showToast({title:"该id已存在",icon:"none"}),void(n.value=!1);const{result:s}=await i.collection("user").add({...l,avatarUrl:"",pwd:"$2a$10$WOW5NsssssCKafZZNDt9PO54RS1ZgoulTWhPl/1c5TTTnUI/w34Pq",type:a});if(console.log(s.id),s.id){const{result:a}=await i.collection("user").doc(s.id).update({avatarUrl:`https://api.multiavatar.com/${s.id}.png`,nickName:`微信管理员${s.id}`});console.log(a);const o=await e.index.showModal({title:"添加成功",content:"id:"+s.id,showCancel:!0,confirmText:"复制"});u.value={},o.confirm&&e.index.setClipboardData({data:s.id,showToast:!0})}}catch(l){console.log(l),e.index.showToast({title:l[0].errorMessage,icon:"none"})}n.value=!1,e.index.hideLoading()},$=async a=>{e.index.showLoading({title:"加载中",mask:!0}),n.value=!0;try{let a=await o.$vm.$refs.resetPwdForm.validate();console.log(a);const l=e.Ws.database(),{result:i}=await l.collection("user").doc(a.id).update({pwd:"$2a$10$WOW5NsssssCKafZZNDt9PO54RS1ZgoulTWhPl/1c5TTTnUI/w34Pq"});if(i.updated>0)return e.index.showToast({title:"重置成功",icon:"success"}),void(n.value=!1)}catch(l){console.log(l),e.index.showToast({title:l[0].errorMessage,icon:"none"})}n.value=!1,e.index.hideLoading()};return(a,o)=>e.e({a:l.value},l.value?{b:e.p({title:"我的信息",type:"line"}),c:l.value.avatarUrl,d:e.p({clickable:!0,showArrow:!0}),e:e.o(y),f:e.o(x),g:e.t(l.value.nickName),h:e.o((e=>w("昵称",l.value.nickName))),i:e.p({clickable:!0,showArrow:!0,title:"昵称"}),j:e.t(l.value.name),k:e.o((e=>w("姓名",l.value.name))),l:e.o((e=>t(l.value.name))),m:e.p({clickable:1==l.value.type,showArrow:1==l.value.type,title:"姓名"}),n:e.t(l.value._id),o:e.o((e=>t(l.value._id))),p:e.p({title:1==l.value.type?"学号/id":"学号"}),q:e.t(l.value.class),r:e.o((e=>w("班级",l.value.class))),s:e.p({clickable:1==l.value.type,showArrow:1==l.value.type,title:"班级"}),t:e.p({open:i.value,titleBorder:"none"}),v:e.p({padding:"0"})}:{},{w:!l.value},l.value?{}:{x:e.p({title:"登录",type:"line"}),y:e.o((e=>s.value.id=e)),z:e.p({placeholder:"请输入账号/学号",modelValue:s.value.id}),A:e.p({label:"账号",required:!0,name:"id"}),B:e.o((e=>s.value.pwd=e)),C:e.p({type:"password",placeholder:"请输入密码",modelValue:s.value.pwd}),D:e.p({label:"密码",required:!0,name:"pwd"}),E:e.sr("form","0525e47d-11,0525e47d-9"),F:e.p({modelValue:s.value}),G:n.value,H:e.o((e=>c("form"))),I:e.p({padding:"0"})},{J:l.value},l.value?{K:e.p({title:"修改密码",type:"line"}),L:e.o((e=>s.value.pwd=e)),M:e.p({trim:"both",type:"password",placeholder:"请输入密码",modelValue:s.value.pwd}),N:e.p({label:"旧密码",required:!0,name:"pwd"}),O:e.o((e=>s.value.newpwd=e)),P:e.p({trim:"both",type:"password",placeholder:"请输入新密码",modelValue:s.value.newpwd}),Q:e.p({label:"新密码",required:!0,name:"newpwd"}),R:e.o((e=>s.value.newpwd2=e)),S:e.p({trim:"both",type:"password",placeholder:"请确认新密码",modelValue:s.value.newpwd2}),T:e.p({label:"确认密码",required:!0,name:"newpwd2"}),U:e.sr("form1","0525e47d-20,0525e47d-18"),V:e.p({modelValue:s.value,"label-width":"80px"}),W:n.value,X:e.o((e=>c("form1"))),Y:e.p({titleBorder:"none"}),Z:e.p({padding:"0"})}:{},{aa:1==l.value.type},1==l.value.type?{ab:e.p({title:"添加学生（管理员）",type:"line"}),ac:e.o((e=>u.value.id=e)),ad:e.p({trim:"both",placeholder:"输入学号/id（留空自动生成id）",modelValue:u.value.id}),ae:e.p({label:"学号/id",name:"id"}),af:e.o((e=>u.value.name=e)),ag:e.p({trim:"both",placeholder:"请输入姓名",modelValue:u.value.name}),ah:e.p({label:"姓名",required:!0,name:"name"}),ai:e.o((e=>u.value.class=e)),aj:e.p({trim:"both",placeholder:"请输入班级",modelValue:u.value.class}),ak:e.p({label:"班级",required:!0,name:"class"}),al:e.sr("addStudentForm","0525e47d-31,0525e47d-29"),am:e.p({modelValue:u.value,"label-width":"80px"}),an:n.value,ao:e.o(T),ap:e.p({titleBorder:"none"}),aq:e.p({padding:"0"})}:{},{ar:1==l.value.type},1==l.value.type?{as:e.p({title:"重置密码（管理员）",type:"line"}),at:e.o((e=>d.value.id=e)),av:e.p({trim:"both",placeholder:"输入学号/id",modelValue:d.value.id}),aw:e.p({required:!0,label:"学号/id",name:"id"}),ax:e.sr("resetPwdForm","0525e47d-42,0525e47d-40"),ay:e.p({modelValue:d.value,"label-width":"80px"}),az:n.value,aA:e.o($),aB:e.p({titleBorder:"none"}),aC:e.p({padding:"0"})}:{},{aD:1==l.value.type},1==l.value.type?{aE:e.p({title:"添加全局管理员（管理员）",type:"line"}),aF:e.o((e=>u.value.id=e)),aG:e.p({trim:"both",placeholder:"输入学号/id（留空自动生成id）",modelValue:u.value.id}),aH:e.p({label:"id",name:"id"}),aI:e.sr("addAdminForm","0525e47d-49,0525e47d-47"),aJ:e.p({modelValue:u.value,"label-width":"80px"}),aK:n.value,aL:e.o((e=>T(1))),aM:e.p({titleBorder:"none"}),aN:e.p({padding:"0"})}:{},{aO:b.value},b.value?{aP:e.sr("inputClose","0525e47d-53,0525e47d-52"),aQ:e.o(h),aR:e.o((e=>b.value=!1)),aS:e.o((e=>m.value.value=e)),aT:e.p({mode:"input",title:m.value.title,placeholder:m.value.placeholder,modelValue:m.value.value}),aU:e.sr("inputDialog","0525e47d-52"),aV:e.p({type:"dialog"})}:{},{aW:l.value},l.value?{aX:n.value,aY:e.o(v)}:{},{aZ:e.s(i.value?"transition: all .5s ease; opacity: 1":"")})}},o=e._export_sfc(a,[["__scopeId","data-v-0525e47d"]]);wx.createPage(o);
