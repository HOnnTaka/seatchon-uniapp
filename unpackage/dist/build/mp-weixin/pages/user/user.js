"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-list-item")+e.resolveComponent("uni-list")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../uni_modules/uni-list/components/uni-list/uni-list.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const o={__name:"user",setup(o){const t=e.ref(e.index.getStorageSync("userinfo")),l=e.ref({value:"",title:"",placeholder:""}),a=async o=>{const l=o.detail.avatarUrl;e.index.showLoading({title:"上传中",mask:!0});try{const{fileID:o}=await e.Ws.uploadFile({filePath:l,cloudPath:"avatar/"+t.value._openid+".png",fileType:"image"}),{fileList:a}=await e.Ws.getTempFileURL({fileList:[o]}),{result:i}=await e.Ws.database().collection("user").doc(t.value._id).update({avatarUrl:a[0].tempFileURL});if(i.updated>0)return t.value.avatarUrl=a[0].tempFileURL,e.index.setStorageSync("userinfo",t.value),void e.index.showToast({title:"上传成功",icon:"success"})}catch(a){console.log(a)}e.index.showToast({title:"上传失败",icon:"none"})},i=e=>{l.value={type:e,title:"编辑"+e,placeholder:"请输入"+e},getCurrentPages()[0].$vm.$refs.inputDialog.open()},n={"昵称":"nickName","姓名":"stuInfo.name","学号":"stuInfo.id","班级":"stuInfo.class"},s=async o=>{const a=o.trim();if(0===a.length)return void e.index.showToast({title:"内容不能为空",icon:"none"});const{type:i}=l.value,{result:s}=await e.Ws.database().collection("user").doc(t.value._id).update({[`${n[i]}`]:a});0==s.errCode?("昵称"==i?t.value.nickName=a:t.value.stuInfo[n[i].replace("stuInfo.","")]=a,e.index.setStorageSync("userinfo",t.value),l.value={},e.index.showToast({title:"修改成功",icon:"success"}),getCurrentPages()[0].$vm.$refs.inputDialog.close()):e.index.showToast({title:"修改失败",icon:"none"})},u=e.ref(0),r=async()=>{if(u.value++,console.log(u.value),u.value>=5){console.log(t.value.type);const{result:o}=await e.Ws.database().collection("user").doc(t.value._id).update({type:0==t.value.type?1:0});console.log(o),0==o.errCode&&e.index.reLaunch({url:"/pages/index/index"})}};return(o,n)=>({a:t.value.avatarUrl,b:e.p({clickable:!0,showArrow:!0,title:"头像"}),c:e.o(r),d:e.o(a),e:e.t(t.value.nickName),f:e.o((e=>i("昵称"))),g:e.p({clickable:!0,showArrow:!0,title:"昵称"}),h:e.t(t.value.stuInfo.name||"未设置"),i:e.o((e=>i("姓名"))),j:e.p({clickable:!0,showArrow:!0,title:"姓名"}),k:e.t(t.value.stuInfo.id||"未设置"),l:e.o((e=>i("学号"))),m:e.p({clickable:!0,showArrow:!0,title:"学号"}),n:e.t(t.value.stuInfo.class||"未设置"),o:e.o((e=>i("班级"))),p:e.p({clickable:!0,showArrow:!0,title:"班级"}),q:e.sr("inputClose","249eac86-7,249eac86-6"),r:e.o(s),s:e.o((e=>l.value.value=e)),t:e.p({mode:"input",title:l.value.title,placeholder:l.value.placeholder,modelValue:l.value.value}),v:e.sr("inputDialog","249eac86-6"),w:e.p({type:"dialog"})})}};wx.createPage(o);
