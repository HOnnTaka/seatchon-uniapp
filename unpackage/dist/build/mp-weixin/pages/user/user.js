"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-section")+e.resolveComponent("uni-list-item")+e.resolveComponent("uni-collapse-item")+e.resolveComponent("uni-collapse")+e.resolveComponent("uni-card")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-forms")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-section/components/uni-section/uni-section.js")+(()=>"../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse-item/uni-collapse-item.js")+(()=>"../../uni_modules/uni-collapse/components/uni-collapse/uni-collapse.js")+(()=>"../../uni_modules/uni-card/components/uni-card/uni-card.js")+(()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const a={__name:"user",setup(a){const l=getCurrentPages().find((e=>"pages/user/user"===e.route)),o=e.ref(e.index.getStorageSync("userinfo")),i=e.ref(!1),n=e.ref(!1);e.onShow((async()=>{setTimeout((()=>{i.value=!0}),100)})),e.onHide((async()=>{i.value=!1}));const t=a=>{console.log(a),e.index.setClipboardData({data:a,showToast:!0,success:function(){e.index.vibrateShort()}})},s=e.ref({id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""}),u=e.ref({id:"",name:"",class:""}),d=e.ref({id:""});e.onLoad((()=>{}));const r={id:{rules:[{required:!0,errorMessage:"请输入学号/id"}]},pwd:{rules:[{required:!0,errorMessage:"请输入密码"}]},adminpwd:{rules:[{required:!0,errorMessage:"请输入管理密码"}]},newpwd:{rules:[{required:!0,errorMessage:"请输入新密码"},{validateFunction:function(e,a,l,o){/^[a-zA-Z0-9]{8,20}$/.test(a)||o("密码必须为8-20位字母、数字")}}]},newpwd2:{rules:[{required:!0,errorMessage:"请确认新密码"},{validateFunction:function(e,a,l,o){a!=s.value.newpwd&&o("两次密码输入不一致")}}]}},p={name:{rules:[{required:!0,errorMessage:"请输入姓名"}]},class:{rules:[{required:!0,errorMessage:"请输入班级"}]}};e.onReady((async()=>{var e,a,o,i,n;null==(e=l.$vm.$refs.form)||e.setRules(r),null==(a=l.$vm.$refs.form1)||a.setRules(r),null==(o=l.$vm.$refs.adminform)||o.setRules(r),null==(i=l.$vm.$refs.addStudentForm)||i.setRules(p),null==(n=l.$vm.$refs.resetPwdForm)||n.setRules(r)}));const c=async a=>{e.index.showLoading({title:"加载中",mask:!0}),n.value=!0;try{let t=await l.$vm.$refs[a].validate();if("adminform"==a){try{const{code:a}=await e.index.login(),{result:l}=await e.Ws.callFunction({name:"login",data:{adminpwd:t.adminpwd,code:a}});console.log(l),e.index.showToast({title:l.message,icon:1==l.code?"error":"success"}),0==l.code&&(e.index.setStorageSync("userinfo",l.userinfo),e.index.reLaunch({url:"/pages/user/user"}))}catch(i){e.index.showToast({title:"请使用微信小程序打开",icon:"none",duration:2e3}),n.value=!1}return}o.value&&(t.id=o.value._id);try{console.log(t,o.value);const{result:a}=await e.Ws.callFunction({name:"login",data:t});console.log(a),e.index.showToast({title:a.message,icon:1==a.code?"error":"success"}),1!=a.code&&(3!=a.code&&(e.index.setStorageSync("userinfo",a.userinfo),o.value=a.userinfo,e.index.reLaunch({url:"/pages/user/user"}),2==a.code&&e.index.showToast({title:"请尽快修改默认密码",icon:"none",duration:4e3})),s.value={id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""})}catch(i){console.log(i),e.index.showToast({title:i.message,icon:"none",duration:2e3}),n.value=!1}}catch(i){return console.log(i),e.index.showToast({title:i[0].errorMessage,icon:"error",duration:2e3}),void(n.value=!1)}n.value=!1,e.index.hideLoading()},v=async()=>{n.value=!0;const a=await e.Ws.callFunction({name:"logout"});console.log(a),a&&(e.index.setStorageSync("userinfo",""),o.value="",e.index.showToast({title:"退出登录成功",icon:"success"}),n.value=!1)},m=e.ref({value:"",title:"",placeholder:""}),w=async(e,a)=>{m.value={type:e,title:"编辑"+e,placeholder:"请输入"+e,value:a},x.value=!0,setTimeout((()=>{l.$vm.$refs.inputDialog.open()}))},g={"昵称":"nickName","姓名":"name","班级":"class"},h=async a=>{const i=a.trim();if(0===i.length)return void e.index.showToast({title:"内容不能为空",icon:"none"});const{type:n}=m.value,{result:t}=await e.Ws.database().collection("user").doc(o.value._id).update({[`${g[n]}`]:i});if(0==t.errCode)return"昵称"==n?o.value.nickName=i:o.value[g[n].replace("stuInfo.","")]=i,e.index.setStorageSync("userinfo",o.value),m.value={},e.index.showToast({title:"修改成功",icon:"success"}),x.value=!0,void l.$vm.$refs.inputDialog.close();e.index.showToast({title:"修改失败",icon:"none"})},f=e.ref(0),y=async()=>{if(f.value++,console.log(f.value),f.value>=5){console.log(o.value.type);const{result:a}=await e.Ws.database().collection("user").doc(o.value._id).update({type:0==o.value.type?1:0});console.log(a),0==a.errCode&&(o.value.type=0==o.value.type?1:0,e.index.setStorageSync("userinfo",o.value),e.index.reLaunch({url:"/pages/index/index"}))}},b=async a=>{const l=a.detail.avatarUrl;e.index.showLoading({title:"上传中",mask:!0}),n.value=!0;try{const{fileID:a}=await e.Ws.uploadFile({filePath:l,cloudPath:"avatar/"+o.value._id+".png",fileType:"image"}),{fileList:i}=await e.Ws.getTempFileURL({fileList:[a]}),{result:t}=await e.Ws.database().collection("user").doc(o.value._id).update({avatarUrl:i[0].tempFileURL});if(t.updated>0)return o.value.avatarUrl=i[0].tempFileURL,e.index.setStorageSync("userinfo",o.value),e.index.showToast({title:"上传成功",icon:"success"}),void(n.value=!1)}catch(i){console.log(i)}n.value=!1,e.index.showToast({title:"上传失败",icon:"none"})},x=e.ref(!1),T=async(a=0)=>{e.index.showLoading({title:"加载中",mask:!0}),n.value=!0;try{let o=0==a?await l.$vm.$refs.addStudentForm.validate():await l.$vm.$refs.addAdminForm.validate();""!=o.id&&(o._id=o.id),delete o.id,console.log(o);const i=e.Ws.database(),{result:t}=await i.collection("user").doc(o._id).field("_id").get();if(t.data.length>0)return e.index.showToast({title:"该id已存在",icon:"none"}),void(n.value=!1);const{result:s}=await i.collection("user").add({...o,avatarUrl:"",pwd:"$2a$10$WOW5NsssssCKafZZNDt9PO54RS1ZgoulTWhPl/1c5TTTnUI/w34Pq",type:a});if(console.log(s.id),s.id){const{result:a}=await i.collection("user").doc(s.id).update({avatarUrl:`https://api.multiavatar.com/${s.id}.png`,nickName:`微信管理员${s.id}`});console.log(a);const l=await e.index.showModal({title:"添加成功",content:"id:"+s.id,showCancel:!0,confirmText:"复制"});u.value={},l.confirm&&e.index.setClipboardData({data:s.id,showToast:!0})}}catch(o){console.log(o),e.index.showToast({title:o[0].errorMessage,icon:"none"})}n.value=!1,e.index.hideLoading()},$=async a=>{e.index.showLoading({title:"加载中",mask:!0}),n.value=!0;try{let a=await l.$vm.$refs.resetPwdForm.validate();console.log(a);const o=e.Ws.database(),{result:i}=await o.collection("user").doc(a.id).update({pwd:"$2a$10$WOW5NsssssCKafZZNDt9PO54RS1ZgoulTWhPl/1c5TTTnUI/w34Pq"});if(i.updated>0)return e.index.showToast({title:"重置成功",icon:"success"}),void(n.value=!1)}catch(o){console.log(o),e.index.showToast({title:o[0].errorMessage,icon:"none"})}n.value=!1,e.index.hideLoading()};return(a,l)=>e.e({a:o.value},o.value?{b:e.p({title:"我的信息",type:"line"}),c:o.value.avatarUrl,d:e.p({clickable:!0,showArrow:!0}),e:e.o(y),f:e.o(b),g:e.t(o.value.nickName),h:e.o((e=>w("昵称",o.value.nickName))),i:e.p({clickable:!0,showArrow:!0,title:"昵称"}),j:e.t(o.value.name),k:e.o((e=>w("姓名",o.value.name))),l:e.o((e=>t(o.value.name))),m:e.p({clickable:1==o.value.type,showArrow:1==o.value.type,title:"姓名"}),n:e.t(o.value._id),o:e.o((e=>t(o.value._id))),p:e.p({title:1==o.value.type?"学号/id":"学号"}),q:e.t(o.value.class),r:e.o((e=>w("班级",o.value.class))),s:e.p({clickable:1==o.value.type,showArrow:1==o.value.type,title:"班级"}),t:e.p({open:i.value,titleBorder:"none"}),v:e.p({padding:"0"})}:{},{w:!o.value},o.value?{}:{x:e.p({title:"登录",type:"line"}),y:e.o((e=>s.value.id=e)),z:e.p({placeholder:"请输入账号/学号",modelValue:s.value.id}),A:e.p({label:"账号",required:!0,name:"id"}),B:e.o((e=>s.value.pwd=e)),C:e.p({type:"password",placeholder:"请输入密码",modelValue:s.value.pwd}),D:e.p({label:"密码",required:!0,name:"pwd"}),E:e.sr("form","1ce2b77e-11,1ce2b77e-9"),F:e.p({modelValue:s.value}),G:n.value,H:e.o((e=>c("form"))),I:e.p({padding:"0"})},{J:!o.value},o.value?{}:{K:e.p({title:"管理员登录",type:"line"}),L:e.o((e=>s.value.adminpwd=e)),M:e.p({placeholder:"请输入管理密码",modelValue:s.value.adminpwd}),N:e.p({name:"adminpwd"}),O:e.sr("adminform","1ce2b77e-18,1ce2b77e-16"),P:e.p({modelValue:s.value}),Q:n.value,R:e.o((e=>c("adminform"))),S:e.p({padding:"0"})},{T:o.value},o.value?{U:e.p({title:"修改密码",type:"line"}),V:e.o((e=>s.value.pwd=e)),W:e.p({trim:"both",type:"password",placeholder:"请输入密码",modelValue:s.value.pwd}),X:e.p({label:"旧密码",required:!0,name:"pwd"}),Y:e.o((e=>s.value.newpwd=e)),Z:e.p({trim:"both",type:"password",placeholder:"请输入新密码",modelValue:s.value.newpwd}),aa:e.p({label:"新密码",required:!0,name:"newpwd"}),ab:e.o((e=>s.value.newpwd2=e)),ac:e.p({trim:"both",type:"password",placeholder:"请确认新密码",modelValue:s.value.newpwd2}),ad:e.p({label:"确认密码",required:!0,name:"newpwd2"}),ae:e.sr("form1","1ce2b77e-25,1ce2b77e-23"),af:e.p({modelValue:s.value,"label-width":"80px"}),ag:n.value,ah:e.o((e=>c("form1"))),ai:e.p({titleBorder:"none"}),aj:e.p({padding:"0"})}:{},{ak:1==o.value.type},1==o.value.type?{al:e.p({title:"添加学生（管理员）",type:"line"}),am:e.o((e=>u.value.id=e)),an:e.p({trim:"both",placeholder:"输入学号/id（留空自动生成id）",modelValue:u.value.id}),ao:e.p({label:"学号/id",name:"id"}),ap:e.o((e=>u.value.name=e)),aq:e.p({trim:"both",placeholder:"请输入姓名",modelValue:u.value.name}),ar:e.p({label:"姓名",required:!0,name:"name"}),as:e.o((e=>u.value.class=e)),at:e.p({trim:"both",placeholder:"请输入班级",modelValue:u.value.class}),av:e.p({label:"班级",required:!0,name:"class"}),aw:e.sr("addStudentForm","1ce2b77e-36,1ce2b77e-34"),ax:e.p({modelValue:u.value,"label-width":"80px"}),ay:n.value,az:e.o(T),aA:e.p({titleBorder:"none"}),aB:e.p({padding:"0"})}:{},{aC:1==o.value.type},1==o.value.type?{aD:e.p({title:"重置密码（管理员）",type:"line"}),aE:e.o((e=>d.value.id=e)),aF:e.p({trim:"both",placeholder:"输入学号/id",modelValue:d.value.id}),aG:e.p({required:!0,label:"学号/id",name:"id"}),aH:e.sr("resetPwdForm","1ce2b77e-47,1ce2b77e-45"),aI:e.p({modelValue:d.value,"label-width":"80px"}),aJ:n.value,aK:e.o($),aL:e.p({titleBorder:"none"}),aM:e.p({padding:"0"})}:{},{aN:1==o.value.type},1==o.value.type?{aO:e.p({title:"添加全局管理员（管理员）",type:"line"}),aP:e.o((e=>u.value.id=e)),aQ:e.p({trim:"both",placeholder:"输入学号/id（留空自动生成id）",modelValue:u.value.id}),aR:e.p({label:"id",name:"id"}),aS:e.sr("addAdminForm","1ce2b77e-54,1ce2b77e-52"),aT:e.p({modelValue:u.value,"label-width":"80px"}),aU:n.value,aV:e.o((e=>T(1))),aW:e.p({titleBorder:"none"}),aX:e.p({padding:"0"})}:{},{aY:x.value},x.value?{aZ:e.sr("inputClose","1ce2b77e-58,1ce2b77e-57"),ba:e.o(h),bb:e.o((e=>x.value=!1)),bc:e.o((e=>m.value.value=e)),bd:e.p({mode:"input",title:m.value.title,placeholder:m.value.placeholder,modelValue:m.value.value}),be:e.sr("inputDialog","1ce2b77e-57"),bf:e.p({type:"dialog"})}:{},{bg:o.value},o.value?{bh:n.value,bi:e.o(v)}:{},{bj:e.s(i.value?"transition: all .5s ease; opacity: 1":"")})}},l=e._export_sfc(a,[["__scopeId","data-v-1ce2b77e"]]);wx.createPage(l);
