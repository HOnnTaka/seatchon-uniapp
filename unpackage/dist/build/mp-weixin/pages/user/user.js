"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-section")+e.resolveComponent("uni-list-item")+e.resolveComponent("uni-list")+e.resolveComponent("uni-card")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-forms")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-section/components/uni-section/uni-section.js")+(()=>"../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+(()=>"../../uni_modules/uni-list/components/uni-list/uni-list.js")+(()=>"../../uni_modules/uni-card/components/uni-card/uni-card.js")+(()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const o={__name:"user",setup(o){const a=e.ref(e.index.getStorageSync("userinfo")),n=e.ref({id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""});e.onLoad((()=>{}));const l={id:{rules:[{required:!0,errorMessage:"请输入账号/学号"}]},pwd:{rules:[{required:!0,errorMessage:"请输入密码"}]},adminpwd:{rules:[{required:!0,errorMessage:"请输入管理密码"}]},newpwd:{rules:[{required:!0,errorMessage:"请输入新密码"},{validateFunction:function(e,o,a,n){/^[a-zA-Z0-9]{8,20}$/.test(o)||n("密码必须为8-20位字母、数字")}}]},newpwd2:{rules:[{required:!0,errorMessage:"请确认新密码"},{validateFunction:function(e,o,a,l){o!=n.value.newpwd&&l("两次密码输入不一致")}}]}};e.onReady((async()=>{var e,o,a;null==(e=getCurrentPages()[0].$vm.$refs.form)||e.setRules(l),null==(o=getCurrentPages()[0].$vm.$refs.form1)||o.setRules(l),null==(a=getCurrentPages()[0].$vm.$refs.adminform)||a.setRules(l)}));const i=async o=>{e.index.showLoading({title:"加载中",mask:!0});try{let i=await getCurrentPages()[0].$vm.$refs[o].validate();if("adminform"==o){try{const{code:o}=await e.index.login(),{result:a}=await e.Ws.callFunction({name:"login",data:{adminpwd:i.adminpwd,code:o}});console.log(a),e.index.showToast({title:a.message,icon:1==a.code?"error":"success"}),0==a.code&&(e.index.setStorageSync("userinfo",a.userinfo),e.index.reLaunch({url:"/pages/user/user"}))}catch(l){console.log(l),e.index.showToast({title:"请使用微信小程序打开",icon:"none",duration:2e3})}return}a.value&&(i.id=a.value._id);try{console.log(i,a.value);const{result:o}=await e.Ws.callFunction({name:"login",data:i});console.log(o),e.index.showToast({title:o.message,icon:1==o.code?"error":"success"}),1!=o.code&&(3!=o.code&&(e.index.setStorageSync("userinfo",o.userinfo),a.value=o.userinfo,e.index.reLaunch({url:"/pages/user/user"}),2==o.code&&e.index.showToast({title:"请尽快修改默认密码",icon:"none",duration:4e3})),n.value={id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""})}catch(l){console.log(l),e.index.showToast({title:l.message,icon:"none",duration:2e3})}}catch(l){return console.log(l),void e.index.showToast({title:"请检查输入内容",icon:"none",duration:2e3})}e.index.hideLoading()},t=()=>{e.index.setStorageSync("userinfo",""),a.value="",e.index.showToast({title:"退出登录成功",icon:"success"})},s=e.ref({value:"",title:"",placeholder:""}),u={"昵称":"nickName"},d=async o=>{const n=o.trim();if(0===n.length)return void e.index.showToast({title:"内容不能为空",icon:"none"});const{type:l}=s.value,{result:i}=await e.Ws.database().collection("user").doc(a.value._id).update({[`${u[l]}`]:n});if(0==i.errCode)return"昵称"==l?a.value.nickName=n:a.value.stuInfo[u[l].replace("stuInfo.","")]=n,e.index.setStorageSync("userinfo",a.value),s.value={},e.index.showToast({title:"修改成功",icon:"success"}),m.value=!0,void getCurrentPages()[0].$vm.$refs.inputDialog.close();e.index.showToast({title:"修改失败",icon:"none"})},r=e.ref(0),p=async()=>{if(r.value++,console.log(r.value),r.value>=5){console.log(a.value.type);const{result:o}=await e.Ws.database().collection("user").doc(a.value._id).update({type:0==a.value.type?1:0});console.log(o),0==o.errCode&&(a.value.type=0==a.value.type?1:0,e.index.setStorageSync("userinfo",a.value),e.index.reLaunch({url:"/pages/index/index"}))}},c=async o=>{const n=o.detail.avatarUrl;e.index.showLoading({title:"上传中",mask:!0});try{const{fileID:o}=await e.Ws.uploadFile({filePath:n,cloudPath:"avatar/"+a.value._id+".png",fileType:"image"}),{fileList:l}=await e.Ws.getTempFileURL({fileList:[o]}),{result:i}=await e.Ws.database().collection("user").doc(a.value._id).update({avatarUrl:l[0].tempFileURL});if(i.updated>0)return a.value.avatarUrl=l[0].tempFileURL,e.index.setStorageSync("userinfo",a.value),void e.index.showToast({title:"上传成功",icon:"success"})}catch(l){console.log(l)}e.index.showToast({title:"上传失败",icon:"none"})},m=e.ref(!1),v=e.ref(null);return(o,l)=>e.e({a:a.value},a.value?{b:e.p({title:"我的信息",type:"line"}),c:a.value.avatarUrl,d:e.p({border:!1,clickable:!0,showArrow:!0}),e:e.o(p),f:e.o(c),g:e.t(a.value.nickName),h:e.o((e=>(async(e,o)=>{s.value={type:e,title:"编辑"+e,placeholder:"请输入"+e,value:o},m.value=!0,setTimeout((()=>{getCurrentPages()[0].$vm.$refs.inputDialog.open()}))})("昵称",a.value.nickName))),i:e.p({clickable:!0,showArrow:!0,title:"昵称"}),j:e.t(a.value.name||"未设置"),k:e.p({title:"姓名"}),l:e.t(a.value._id||"未设置"),m:e.p({title:"学号"}),n:e.t(a.value.class||"未设置"),o:e.p({title:"班级"}),p:e.p({padding:"0"})}:{},{q:!a.value},a.value?{}:{r:e.p({title:"登录",type:"line"}),s:e.o((e=>n.value.id=e)),t:e.p({placeholder:"请输入账号/学号",modelValue:n.value.id}),v:e.p({label:"账号",required:!0,name:"id"}),w:e.o((e=>n.value.pwd=e)),x:e.p({type:"password",placeholder:"请输入密码",modelValue:n.value.pwd}),y:e.p({label:"密码",required:!0,name:"pwd"}),z:e.sr("form","12d737d4-10,12d737d4-8"),A:e.p({modelValue:n.value}),B:e.o((e=>i("form"))),C:e.p({padding:"0"})},{D:!a.value},a.value?{}:{E:e.p({title:"管理员登录",type:"line"}),F:e.o((e=>n.value.adminpwd=e)),G:e.p({placeholder:"请输入管理密码",modelValue:n.value.adminpwd}),H:e.p({name:"adminpwd"}),I:e.sr("adminform","12d737d4-17,12d737d4-15"),J:e.p({modelValue:n.value}),K:e.o((e=>i("adminform"))),L:e.p({padding:"0"})},{M:a.value},a.value?{N:e.p({title:"修改密码",type:"line"}),O:e.o((e=>n.value.pwd=e)),P:e.p({type:"password",placeholder:"请输入密码",modelValue:n.value.pwd}),Q:e.p({label:"旧密码",required:!0,name:"pwd"}),R:e.o((e=>n.value.newpwd=e)),S:e.p({type:"password",placeholder:"请输入新密码",modelValue:n.value.newpwd}),T:e.p({label:"新密码",required:!0,name:"newpwd"}),U:e.o((e=>n.value.newpwd2=e)),V:e.p({type:"password",placeholder:"请确认新密码",modelValue:n.value.newpwd2}),W:e.p({label:"确认密码",required:!0,name:"newpwd2"}),X:e.sr("form1","12d737d4-22,12d737d4-20"),Y:e.p({modelValue:n.value,"label-width":"80px"}),Z:e.o((e=>i("form1"))),aa:e.p({padding:"0"})}:{},{ab:m.value},m.value?{ac:e.sr("inputClose","12d737d4-30,12d737d4-29"),ad:e.o(d),ae:e.o((e=>m.value=!1)),af:e.o((e=>s.value.value=e)),ag:e.p({mode:"input",title:s.value.title,placeholder:s.value.placeholder,modelValue:s.value.value}),ah:e.sr(v,"12d737d4-29",{k:"inputDialog"}),ai:e.p({type:"dialog"})}:{},{aj:a.value},a.value?{ak:e.o(t)}:{})}},a=e._export_sfc(o,[["__scopeId","data-v-12d737d4"]]);wx.createPage(a);
