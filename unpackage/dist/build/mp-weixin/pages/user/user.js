"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-list-item")+e.resolveComponent("uni-section")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-forms")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}const a=()=>"../../uni_modules/uni-section/components/uni-section/uni-section.js",o=()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js",n=()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js",l=()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js",i=()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js",s=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||((()=>"../../uni_modules/uni-list/components/uni-list-item/uni-list-item.js")+e.unref(t)+a+o+n+l+i+s)();const t=()=>"../../component/CardList/CardList.js",u={__name:"user",setup(a){const o=e.ref(e.index.getStorageSync("userinfo")),n=e.ref({id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""});e.onLoad((()=>{}));const l={id:{rules:[{required:!0,errorMessage:"请输入账号/学号"}]},pwd:{rules:[{required:!0,errorMessage:"请输入密码"}]},adminpwd:{rules:[{required:!0,errorMessage:"请输入管理密码"}]},newpwd:{rules:[{required:!0,errorMessage:"请输入新密码"},{validateFunction:function(e,a,o,n){/^[a-zA-Z0-9]{8,20}$/.test(a)||n("密码必须为8-20位字母、数字")}}]},newpwd2:{rules:[{required:!0,errorMessage:"请确认新密码"},{validateFunction:function(e,a,o,l){a!=n.value.newpwd&&l("两次密码输入不一致")}}]}};e.onReady((async()=>{var e,a,o;null==(e=getCurrentPages()[0].$vm.$refs.form)||e.setRules(l),null==(a=getCurrentPages()[0].$vm.$refs.form1)||a.setRules(l),null==(o=getCurrentPages()[0].$vm.$refs.adminform)||o.setRules(l)}));const i=async a=>{e.index.showLoading({title:"加载中",mask:!0});try{let i=await getCurrentPages()[0].$vm.$refs[a].validate();if("adminform"==a){try{const{code:a}=await e.index.login(),{result:o}=await e.Ws.callFunction({name:"login",data:{adminpwd:i.adminpwd,code:a}});console.log(o),e.index.showToast({title:o.message,icon:1==o.code?"error":"success"}),0==o.code&&(e.index.setStorageSync("userinfo",o.userinfo),e.index.reLaunch({url:"/pages/user/user"}))}catch(l){console.log(l),e.index.showToast({title:"请使用微信小程序打开",icon:"none",duration:2e3})}return}o.value&&(i.id=o.value._id);try{console.log(i,o.value);const{result:a}=await e.Ws.callFunction({name:"login",data:i});console.log(a),e.index.showToast({title:a.message,icon:1==a.code?"error":"success"}),1!=a.code&&(3!=a.code&&(e.index.setStorageSync("userinfo",a.userinfo),o.value=a.userinfo,e.index.reLaunch({url:"/pages/user/user"}),2==a.code&&e.index.showToast({title:"请尽快修改默认密码",icon:"none",duration:4e3})),n.value={id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""})}catch(l){console.log(l),e.index.showToast({title:l.message,icon:"none",duration:2e3})}}catch(l){return console.log(l),void e.index.showToast({title:"请检查输入内容",icon:"none",duration:2e3})}e.index.hideLoading()},s=()=>{e.index.setStorageSync("userinfo",""),o.value="",e.index.showToast({title:"退出登录成功",icon:"success"})},t=e.ref({value:"",title:"",placeholder:""}),u=async(e,a)=>{t.value={type:e,title:"编辑"+e,placeholder:"请输入"+e,value:a},v.value=!0,setTimeout((()=>{getCurrentPages()[0].$vm.$refs.inputDialog.open()}))},r={"昵称":"nickName"},d=async a=>{const n=a.trim();if(0===n.length)return void e.index.showToast({title:"内容不能为空",icon:"none"});const{type:l}=t.value,{result:i}=await e.Ws.database().collection("user").doc(o.value._id).update({[`${r[l]}`]:n});if(0==i.errCode)return"昵称"==l?o.value.nickName=n:o.value.stuInfo[r[l].replace("stuInfo.","")]=n,e.index.setStorageSync("userinfo",o.value),t.value={},e.index.showToast({title:"修改成功",icon:"success"}),v.value=!0,void getCurrentPages()[0].$vm.$refs.inputDialog.close();e.index.showToast({title:"修改失败",icon:"none"})},p=e.ref(0),c=async()=>{if(p.value++,console.log(p.value),p.value>=5){console.log(o.value.type);const{result:a}=await e.Ws.database().collection("user").doc(o.value._id).update({type:0==o.value.type?1:0});console.log(a),0==a.errCode&&(o.value.type=0==o.value.type?1:0,e.index.setStorageSync("userinfo",o.value),e.index.reLaunch({url:"/pages/index/index"}))}},m=async a=>{const n=a.detail.avatarUrl;e.index.showLoading({title:"上传中",mask:!0});try{const{fileID:a}=await e.Ws.uploadFile({filePath:n,cloudPath:"avatar/"+o.value._id+".png",fileType:"image"}),{fileList:l}=await e.Ws.getTempFileURL({fileList:[a]}),{result:i}=await e.Ws.database().collection("user").doc(o.value._id).update({avatarUrl:l[0].tempFileURL});if(i.updated>0)return o.value.avatarUrl=l[0].tempFileURL,e.index.setStorageSync("userinfo",o.value),void e.index.showToast({title:"上传成功",icon:"success"})}catch(l){console.log(l)}e.index.showToast({title:"上传失败",icon:"none"})},v=e.ref(!1),w=e.ref(null);return(a,l)=>e.e({a:o.value},o.value?{b:o.value.avatarUrl,c:e.p({clickable:!0,showArrow:!0}),d:e.o(c),e:e.o(m),f:e.o((e=>u("昵称",o.value.nickName))),g:o.value.nickName,h:e.o((e=>u("姓名",o.value.name))),i:o.value.name,j:e.o((e=>u("学号",o.value._id))),k:o.value._id,l:e.o((e=>u("班级",o.value.class))),m:o.value.class,n:e.p({title:"我的信息"})}:{},{o:!o.value},o.value?{}:{p:e.p({title:"登录",type:"line"}),q:e.o((e=>n.value.id=e)),r:e.p({placeholder:"请输入账号/学号",modelValue:n.value.id}),s:e.p({label:"账号",required:!0,name:"id"}),t:e.o((e=>n.value.pwd=e)),v:e.p({type:"password",placeholder:"请输入密码",modelValue:n.value.pwd}),w:e.p({label:"密码",required:!0,name:"pwd"}),x:e.sr("form","fb20acb9-4,fb20acb9-2"),y:e.p({modelValue:n.value}),z:e.o((e=>i("form")))},{A:!o.value},o.value?{}:{B:e.p({title:"管理员登录",type:"line"}),C:e.o((e=>n.value.adminpwd=e)),D:e.p({placeholder:"请输入管理密码",modelValue:n.value.adminpwd}),E:e.p({name:"adminpwd"}),F:e.sr("adminform","fb20acb9-11,fb20acb9-9"),G:e.p({modelValue:n.value}),H:e.o((e=>i("adminform")))},{I:o.value},o.value?{J:e.p({title:"修改密码",type:"line"}),K:e.o((e=>n.value.pwd=e)),L:e.p({type:"password",placeholder:"请输入密码",modelValue:n.value.pwd}),M:e.p({label:"旧密码",required:!0,name:"pwd"}),N:e.o((e=>n.value.newpwd=e)),O:e.p({type:"password",placeholder:"请输入新密码",modelValue:n.value.newpwd}),P:e.p({label:"新密码",required:!0,name:"newpwd"}),Q:e.o((e=>n.value.newpwd2=e)),R:e.p({type:"password",placeholder:"请确认新密码",modelValue:n.value.newpwd2}),S:e.p({label:"确认密码",required:!0,name:"newpwd2"}),T:e.sr("form1","fb20acb9-16,fb20acb9-14"),U:e.p({modelValue:n.value,"label-width":"80px"}),V:e.o((e=>i("form1")))}:{},{W:v.value},v.value?{X:e.sr("inputClose","fb20acb9-24,fb20acb9-23"),Y:e.o(d),Z:e.o((e=>v.value=!1)),aa:e.o((e=>t.value.value=e)),ab:e.p({mode:"input",title:t.value.title,placeholder:t.value.placeholder,modelValue:t.value.value}),ac:e.sr(w,"fb20acb9-23",{k:"inputDialog"}),ad:e.p({type:"dialog"})}:{},{ae:o.value},o.value?{af:e.o(s)}:{})}},r=e._export_sfc(u,[["__scopeId","data-v-fb20acb9"]]);wx.createPage(r);
