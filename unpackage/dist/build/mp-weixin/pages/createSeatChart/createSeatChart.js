"use strict";const e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-section")+e.resolveComponent("uni-easyinput")+e.resolveComponent("uni-forms-item")+e.resolveComponent("uni-datetime-picker")+e.resolveComponent("uni-data-checkbox")+e.resolveComponent("uni-card")+e.resolveComponent("uni-number-box")+e.resolveComponent("uni-forms"))()}Math||((()=>"../../uni_modules/uni-section/components/uni-section/uni-section.js")+(()=>"../../uni_modules/uni-easyinput/components/uni-easyinput/uni-easyinput.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms-item/uni-forms-item.js")+(()=>"../../uni_modules/uni-datetime-picker/components/uni-datetime-picker/uni-datetime-picker.js")+(()=>"../../uni_modules/uni-data-checkbox/components/uni-data-checkbox/uni-data-checkbox.js")+(()=>"../../uni_modules/uni-card/components/uni-card/uni-card.js")+(()=>"../../uni_modules/uni-number-box/components/uni-number-box/uni-number-box.js")+(()=>"../../uni_modules/uni-forms/components/uni-forms/uni-forms.js"))();const t={__name:"createSeatChart",setup(t){const a=e.ref(!1),o=e.reactive({title:"",note:"",col:"10",row:"11",stuInfoVisible:0,effectiveTimeRange:[],selectableTimeRange:[]});e.onReady((()=>{setTimeout((()=>{a.value=!0}),100)}));const i=e.ref(""),n=e.ref(""),l=getCurrentPages().find((e=>"pages/createSeatChart/createSeatChart"===e.route));e.onLoad((async t=>{console.log(l),e.index.showLoading({title:"加载中"});const{type:a,chartId:s}=t;if(e.index.setNavigationBarTitle({title:"edit"==a?"编辑课室":"新建课室"}),i.value=a,n.value=s,"edit"==a){const t=e.Ws.database(),{result:a}=await t.collection("seat-chart").doc(s).field("title,note,row,col,stuInfoVisible,effectiveTimeRange,selectableTimeRange").get(),i=a.data[0];console.log(a.data[0],o),o.title=i.title,o.note=i.note,o.col=i.col,o.row=i.row,o.stuInfoVisible=i.stuInfoVisible?0:1,o.effectiveTimeRange=i.effectiveTimeRange,o.selectableTimeRange=i.selectableTimeRange}e.index.hideLoading()}));const s=(new Date).toJSON().substring(0,10),r=e.ref(!1),u=e.ref([]),c=e.computed((()=>{const e=parseInt(o.col),t=parseInt(o.row);r.value=!0;let a=[];u.value=[];for(let o=0;o<t;o++)for(let t=0;t<e;t++)a.push({x:t+1,y:o+1}),u.value.push(1);return r.value=!1,a})),d=e.ref([{text:"允许",value:0},{text:"不允许",value:1}]),m={title:{rules:[{required:!0,errorMessage:"请输入标题"}]},col:{rules:[{required:!0,errorMessage:"请输入列数"},{format:"number",errorMessage:"请输入正确的数字"}]},row:{rules:[{required:!0,errorMessage:"请输入行数"},{format:"number",errorMessage:"请输入正确的数字"}]},selectableTimeRange:{rules:[{required:!0,errorMessage:"请选择开放选择时间"},{type:"array",errorMessage:"请选择开放选择时间"}]},effectiveTimeRange:{rules:[{required:!0,errorMessage:"请选择座位有效时间"},{type:"array",errorMessage:"请选择座位有效时间"}]}},p=e.ref([]),f=[{text:"修改座位表",value:0}],v=async t=>{if((await e.index.showModal({title:"提示",content:"将创建新课室："+o.title,showCancel:!0})).confirm){e.index.showLoading({title:"创建中"});const a=e.index.getStorageSync("userinfo"),o=e.Ws.database(),i=await o.collection("seat-chart").add({...t,stuInfoVisible:0==t.stuInfoVisible,createTime:(new Date).toJSON(),administrators:[a._id],seats:b()});console.log(i),0==i.result.errCode&&(e.index.showToast({title:"创建成功",icon:"success"}),setTimeout((()=>{e.index.navigateBack()}),1e3)),e.index.hideLoading()}},g=async t=>{if(!(await e.index.showModal({title:"提示",content:"将修改课室："+o.title,showCancel:!0})).confirm)return;if(p.value.includes(0)){if(!(await e.index.showModal({title:"提示",content:"修改座位表将删除原有座位",showCancel:!0})).confirm)return}e.index.showLoading({title:"修改中"});const a=e.Ws.database();let i={...t,stuInfoVisible:0==t.stuInfoVisible};p.value.includes(0)&&(i.seats=b());const l=await a.collection("seat-chart").doc(n.value).update(i);if(console.log(l),0==l.result.errCode)return e.index.showToast({title:"修改成功",icon:"success"}),void setTimeout((()=>{e.index.navigateBack()}),1e3);e.index.hideLoading()},b=()=>c.value.map(((e,t)=>({x:e.x,y:e.y,status:u.value[t],index:t+1})));return(t,n)=>{var b,h;return e.e({a:e.p({title:"课室信息",type:"line"}),b:e.o((e=>o.title=e)),c:e.p({trim:"both",placeholder:"请输入标题",modelValue:o.title}),d:e.p({label:"标题（课室）",required:!0,name:"title"}),e:e.o((e=>o.note=e)),f:e.p({trim:"true",placeholder:"请输入备注",modelValue:o.note}),g:e.p({label:"备注",name:"note"}),h:e.o((e=>o.selectableTimeRange=e)),i:e.p({start:e.unref(s),"start-placeholder":e.unref(s),type:"daterange",rangeSeparator:"至",modelValue:o.selectableTimeRange}),j:e.p({required:!0,label:"开放选择时间",name:"selectableTimeRange"}),k:e.o((e=>o.effectiveTimeRange=e)),l:e.p({"start-placeholder":e.unref(s),start:e.unref(s),type:"daterange",rangeSeparator:"至",modelValue:o.effectiveTimeRange}),m:e.p({required:!0,label:"座位生效时间",name:"effectiveTimeRange"}),n:e.o((e=>o.stuInfoVisible=e)),o:e.p({localdata:d.value,modelValue:o.stuInfoVisible}),p:e.p({label:"是否允许查看其它学生信息",required:!0,name:"stuInfoVisible"}),q:e.p({padding:"0"}),r:e.p({title:"座位表",type:"line"}),s:"edit"==i.value},"edit"==i.value?{t:e.o((e=>p.value=e)),v:e.p({multiple:!0,localdata:f,modelValue:p.value})}:{},{w:"edit"!=i.value||(null==(b=p.value)?void 0:b.includes(0))},"edit"!=i.value||(null==(h=p.value)?void 0:h.includes(0))?{x:e.o((e=>o.row=e)),y:e.p({modelValue:o.row}),z:e.p({"label-position":"left",label:"行",required:!0,name:"row"}),A:e.o((e=>o.col=e)),B:e.p({modelValue:o.col}),C:e.p({label:"列",required:!0,name:"col"}),D:e.f(c.value,((t,a,o)=>({a:a,b:1==u.value[a]?1:"",c:e.o((()=>u.value[a]=1==u.value[a]?2:1),a)}))),E:e.s(`--col:${o.col};--row:${o.row};`)}:{},{F:e.p({padding:"0"}),G:r.value,H:e.o((()=>(async t=>{const a=l.$vm;try{const e=await a.$refs[t].validate();console.log(e),r.value=!0,"edit"==i.value?await g(e):await v(e),r.value=!1}catch(o){console.log(o),e.index.showToast({title:o[0].errorMessage,icon:"none"})}})("valiForm"))),I:e.sr("valiForm","03a545ff-0"),J:e.p({"label-width":"100%",modelValue:o,"label-position":"top",rules:m}),K:e.s(a.value?"transition: all .5s ease; opacity: 1":"")})}}};wx.createPage(t);
