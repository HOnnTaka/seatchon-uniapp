import{q as e,s as l,v as a,r as t,o,c as d,w as u,a as i,i as n,b as s,h as r,t as c,d as p,L as m,y as v,C as f,N as g,W as _,J as y,O as w,P as h,D as V,A as b,k,j as $,M as x}from"./index-ToqSIm9Z.js";import{_ as U}from"./uni-section.DjzZqhLH.js";import{_ as C,b as q,c as F,o as T,f as P,r as M,e as R}from"./uni-card.DqZYxwyK.js";import{_ as L}from"./uni-list-item.DWC9pjVq.js";import{_ as N,a as j,b as B,c as D}from"./uni-popup.Dzt14zw-.js";import{_ as I,a as W,b as Z}from"./uni-forms.5GVWqidt.js";const S=C({__name:"user",setup(C){const S=e().find((e=>"pages/user/user"===e.route)),A=l(a("userinfo")),O=l(!1),K=l(!1);q((async()=>{setTimeout((()=>{O.value=!0}),100)})),F((async()=>{O.value=!1}));const z=e=>{console.log(e),m({data:e,showToast:!0,success:function(){v()}})},J=l({id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""}),E=l({id:"",name:"",class:""}),G=l({id:""});T((()=>{}));const H={id:{rules:[{required:!0,errorMessage:"请输入学号/id"}]},pwd:{rules:[{required:!0,errorMessage:"请输入密码"}]},adminpwd:{rules:[{required:!0,errorMessage:"请输入管理密码"}]},newpwd:{rules:[{required:!0,errorMessage:"请输入新密码"},{validateFunction:function(e,l,a,t){/^[a-zA-Z0-9]{8,20}$/.test(l)||t("密码必须为8-20位字母、数字")}}]},newpwd2:{rules:[{required:!0,errorMessage:"请确认新密码"},{validateFunction:function(e,l,a,t){l!=J.value.newpwd&&t("两次密码输入不一致")}}]}},Q={name:{rules:[{required:!0,errorMessage:"请输入姓名"}]},class:{rules:[{required:!0,errorMessage:"请输入班级"}]}};P((async()=>{var e,l,a,t,o;null==(e=S.$vm.$refs.form)||e.setRules(H),null==(l=S.$vm.$refs.form1)||l.setRules(H),null==(a=S.$vm.$refs.adminform)||a.setRules(H),null==(t=S.$vm.$refs.addStudentForm)||t.setRules(Q),null==(o=S.$vm.$refs.resetPwdForm)||o.setRules(H)}));const X=async e=>{f({title:"加载中",mask:!0}),K.value=!0;try{let a=await S.$vm.$refs[e].validate();if("adminform"==e){try{const{code:e}=await g(),{result:l}=await _.callFunction({name:"login",data:{adminpwd:a.adminpwd,code:e}});console.log(l),y({title:l.message,icon:1==l.code?"error":"success"}),0==l.code&&(w("userinfo",l.userinfo),h({url:"/pages/user/user"}))}catch(l){y({title:"请使用微信小程序打开",icon:"none",duration:2e3}),K.value=!1}return}A.value&&(a.id=A.value._id);try{console.log(a,A.value);const{result:e}=await _.callFunction({name:"login",data:a});console.log(e),y({title:e.message,icon:1==e.code?"error":"success"}),1!=e.code&&(3!=e.code&&(w("userinfo",e.userinfo),A.value=e.userinfo,h({url:"/pages/user/user"}),2==e.code&&y({title:"请尽快修改默认密码",icon:"none",duration:4e3})),J.value={id:"",pwd:"",adminpwd:"",newpwd:"",newpwd2:""})}catch(l){console.log(l),y({title:l.message,icon:"none",duration:2e3}),K.value=!1}}catch(l){return console.log(l),y({title:l[0].errorMessage,icon:"error",duration:2e3}),void(K.value=!1)}K.value=!1,V()},Y=async()=>{K.value=!0;const e=await _.callFunction({name:"logout"});console.log(e),e&&(w("userinfo",""),A.value="",y({title:"退出登录成功",icon:"success"}),K.value=!1)},ee=l({value:"",title:"",placeholder:""}),le={"昵称":"nickName"},ae=async e=>{const l=e.trim();if(0===l.length)return void y({title:"内容不能为空",icon:"none"});const{type:a}=ee.value,{result:t}=await _.database().collection("user").doc(A.value._id).update({[`${le[a]}`]:l});if(0==t.errCode)return"昵称"==a?A.value.nickName=l:A.value.stuInfo[le[a].replace("stuInfo.","")]=l,w("userinfo",A.value),ee.value={},y({title:"修改成功",icon:"success"}),ue.value=!0,void S.$vm.$refs.inputDialog.close();y({title:"修改失败",icon:"none"})},te=l(0),oe=async()=>{if(te.value++,console.log(te.value),te.value>=5){console.log(A.value.type);const{result:e}=await _.database().collection("user").doc(A.value._id).update({type:0==A.value.type?1:0});console.log(e),0==e.errCode&&(A.value.type=0==A.value.type?1:0,w("userinfo",A.value),h({url:"/pages/index/index"}))}},de=async e=>{const l=e.detail.avatarUrl;f({title:"上传中",mask:!0}),K.value=!0;try{const{fileID:e}=await _.uploadFile({filePath:l,cloudPath:"avatar/"+A.value._id+".png",fileType:"image"}),{fileList:a}=await _.getTempFileURL({fileList:[e]}),{result:t}=await _.database().collection("user").doc(A.value._id).update({avatarUrl:a[0].tempFileURL});if(t.updated>0)return A.value.avatarUrl=a[0].tempFileURL,w("userinfo",A.value),y({title:"上传成功",icon:"success"}),void(K.value=!1)}catch(a){console.log(a)}K.value=!1,y({title:"上传失败",icon:"none"})},ue=l(!1),ie=async e=>{f({title:"加载中",mask:!0}),K.value=!0;try{let e=await S.$vm.$refs.addStudentForm.validate();""!=e.id&&(e._id=e.id),delete e.id,console.log(e);const l=_.database(),{result:a}=await l.collection("user").doc(e._id).field("_id").get();if(a.data.length>0)return y({title:"该id已存在",icon:"none"}),void(K.value=!1);const{result:t}=await l.collection("user").add({...e,avatarUrl:e._id?`https://api.multiavatar.com/${e._id}.png`:"",pwd:"$2a$10$WOW5NsssssCKafZZNDt9PO54RS1ZgoulTWhPl/1c5TTTnUI/w34Pq",type:0});if(console.log(t.id),t.id){if(!e._id){const{result:e}=await l.collection("user").doc(t._id).update({avatarUrl:`https://api.multiavatar.com/${t.id}.png`})}const a=await b({title:"添加成功",content:"id:"+t.id,showCancel:!0,confirmText:"复制"});E.value={},a.confirm&&m({data:t._id,showToast:!0})}}catch(l){console.log(l),y({title:l[0].errorMessage,icon:"none"})}K.value=!1,V()},ne=async e=>{f({title:"加载中",mask:!0}),K.value=!0;try{let e=await S.$vm.$refs.resetPwdForm.validate();console.log(e);const l=_.database(),{result:a}=await l.collection("user").doc(e.id).update({pwd:"$2a$10$WOW5NsssssCKafZZNDt9PO54RS1ZgoulTWhPl/1c5TTTnUI/w34Pq"});if(a.updated>0)return y({title:"重置成功",icon:"success"}),void(K.value=!1)}catch(l){console.log(l),y({title:l[0].errorMessage,icon:"none"})}K.value=!1,V()};return(e,l)=>{const a=M(t("uni-section"),U),m=k,v=$,f=M(t("uni-list-item"),L),g=x,_=n,y=M(t("uni-collapse-item"),N),w=M(t("uni-collapse"),j),h=M(t("uni-card"),R),V=M(t("uni-easyinput"),I),b=M(t("uni-forms-item"),W),C=M(t("uni-forms"),Z),q=M(t("uni-popup-dialog"),B),F=M(t("uni-popup"),D);return o(),d(_,{class:"container",style:i([{transition:"all 1s ease",opacity:"0"},O.value?"transition: all .5s ease; opacity: 1":""])},{default:u((()=>[A.value?(o(),d(h,{key:0,padding:"0"},{default:u((()=>[s(w,null,{default:u((()=>[s(y,{open:O.value,titleBorder:"none"},{title:u((()=>[s(a,{title:"我的信息",type:"line"})])),default:u((()=>[s(g,{onLongpress:oe,onChooseavatar:de,"open-type":"chooseAvatar","hover-class":"hover",class:"edit-avatar"},{default:u((()=>[s(f,{clickable:"",showArrow:""},{header:u((()=>[s(m,{class:"title"},{default:u((()=>[r("头像")])),_:1})])),footer:u((()=>[s(v,{src:A.value.avatarUrl},null,8,["src"])])),_:1})])),_:1}),s(f,{clickable:"",onClick:l[0]||(l[0]=e=>(async(e,l)=>{ee.value={type:e,title:"编辑"+e,placeholder:"请输入"+e,value:l},ue.value=!0,setTimeout((()=>{S.$vm.$refs.inputDialog.open()}))})("昵称",A.value.nickName)),showArrow:"",title:"昵称"},{footer:u((()=>[s(_,{class:"title"},{default:u((()=>[r(c(A.value.nickName),1)])),_:1})])),_:1}),s(f,{onLongpress:l[1]||(l[1]=e=>z(A.value.name)),title:"姓名"},{footer:u((()=>[s(m,{"user-select":"",selectable:""},{default:u((()=>[r(c(A.value.name),1)])),_:1})])),_:1}),s(f,{onLongpress:l[2]||(l[2]=e=>z(A.value._id)),title:1==A.value.type?"学号/id":"学号"},{footer:u((()=>[s(m,{"user-select":"",selectable:""},{default:u((()=>[r(c(A.value._id),1)])),_:1})])),_:1},8,["title"]),s(f,{title:"班级"},{footer:u((()=>[s(m,{"user-select":"",selectable:""},{default:u((()=>[r(c(A.value.class),1)])),_:1})])),_:1})])),_:1},8,["open"])])),_:1})])),_:1})):p("",!0),A.value?p("",!0):(o(),d(h,{key:1,padding:"0"},{title:u((()=>[s(a,{title:"登录",type:"line"})])),default:u((()=>[s(_,{style:{padding:"10px"}},{default:u((()=>[s(C,{ref:"form",modelValue:J.value},{default:u((()=>[s(b,{label:"账号",required:"",name:"id"},{default:u((()=>[s(V,{modelValue:J.value.id,"onUpdate:modelValue":l[3]||(l[3]=e=>J.value.id=e),placeholder:"请输入账号/学号"},null,8,["modelValue"])])),_:1}),s(b,{label:"密码",required:"",name:"pwd"},{default:u((()=>[s(V,{modelValue:J.value.pwd,"onUpdate:modelValue":l[4]||(l[4]=e=>J.value.pwd=e),type:"password",placeholder:"请输入密码"},null,8,["modelValue"])])),_:1})])),_:1},8,["modelValue"]),s(g,{loading:K.value,type:"primary",onClick:l[5]||(l[5]=e=>X("form"))},{default:u((()=>[r("登录")])),_:1},8,["loading"])])),_:1})])),_:1})),A.value?p("",!0):(o(),d(h,{key:2,padding:"0"},{title:u((()=>[s(a,{title:"管理员登录",type:"line"})])),default:u((()=>[s(_,{style:{padding:"10px"}},{default:u((()=>[s(C,{ref:"adminform",modelValue:J.value},{default:u((()=>[s(b,{name:"adminpwd"},{default:u((()=>[s(V,{modelValue:J.value.adminpwd,"onUpdate:modelValue":l[6]||(l[6]=e=>J.value.adminpwd=e),placeholder:"请输入管理密码"},null,8,["modelValue"])])),_:1})])),_:1},8,["modelValue"]),s(g,{loading:K.value,type:"primary",onClick:l[7]||(l[7]=e=>X("adminform"))},{default:u((()=>[r("管理员登录")])),_:1},8,["loading"])])),_:1})])),_:1})),A.value?(o(),d(h,{key:3,padding:"0"},{default:u((()=>[s(w,null,{default:u((()=>[s(y,{titleBorder:"none"},{title:u((()=>[s(a,{title:"修改密码",type:"line"})])),default:u((()=>[s(_,{style:{padding:"10px"}},{default:u((()=>[s(C,{ref:"form1",modelValue:J.value,"label-width":"80px"},{default:u((()=>[s(b,{label:"旧密码",required:"",name:"pwd"},{default:u((()=>[s(V,{trim:"both",modelValue:J.value.pwd,"onUpdate:modelValue":l[8]||(l[8]=e=>J.value.pwd=e),type:"password",placeholder:"请输入密码"},null,8,["modelValue"])])),_:1}),s(b,{label:"新密码",required:"",name:"newpwd"},{default:u((()=>[s(V,{trim:"both",modelValue:J.value.newpwd,"onUpdate:modelValue":l[9]||(l[9]=e=>J.value.newpwd=e),type:"password",placeholder:"请输入新密码"},null,8,["modelValue"])])),_:1}),s(b,{label:"确认密码",required:"",name:"newpwd2"},{default:u((()=>[s(V,{trim:"both",modelValue:J.value.newpwd2,"onUpdate:modelValue":l[10]||(l[10]=e=>J.value.newpwd2=e),type:"password",placeholder:"请确认新密码"},null,8,["modelValue"])])),_:1})])),_:1},8,["modelValue"]),s(g,{loading:K.value,type:"primary",onClick:l[11]||(l[11]=e=>X("form1"))},{default:u((()=>[r("确认")])),_:1},8,["loading"])])),_:1})])),_:1})])),_:1})])),_:1})):p("",!0),1==A.value.type?(o(),d(h,{key:4,padding:"0"},{default:u((()=>[s(w,null,{default:u((()=>[s(y,{titleBorder:"none"},{title:u((()=>[s(a,{title:"添加学生（管理员）",type:"line"})])),default:u((()=>[s(_,{style:{padding:"10px"}},{default:u((()=>[s(C,{ref:"addStudentForm",modelValue:E.value,"label-width":"80px"},{default:u((()=>[s(b,{label:"学号/id",name:"id"},{default:u((()=>[s(V,{trim:"both",modelValue:E.value.id,"onUpdate:modelValue":l[12]||(l[12]=e=>E.value.id=e),placeholder:"输入学号/id（留空自动生成id）"},null,8,["modelValue"])])),_:1}),s(b,{label:"姓名",required:"",name:"name"},{default:u((()=>[s(V,{trim:"both",modelValue:E.value.name,"onUpdate:modelValue":l[13]||(l[13]=e=>E.value.name=e),placeholder:"请输入姓名"},null,8,["modelValue"])])),_:1}),s(b,{label:"班级",required:"",name:"class"},{default:u((()=>[s(V,{trim:"both",modelValue:E.value.class,"onUpdate:modelValue":l[14]||(l[14]=e=>E.value.class=e),placeholder:"请输入班级"},null,8,["modelValue"])])),_:1}),s(_,{style:{"margin-bottom":"5px","text-align":"center",color:"#ccc"}},{default:u((()=>[r("初始密码为123456")])),_:1})])),_:1},8,["modelValue"]),s(g,{loading:K.value,type:"primary",onClick:ie},{default:u((()=>[r("确认")])),_:1},8,["loading"])])),_:1})])),_:1})])),_:1})])),_:1})):p("",!0),1==A.value.type?(o(),d(h,{key:5,padding:"0"},{default:u((()=>[s(w,null,{default:u((()=>[s(y,{titleBorder:"none"},{title:u((()=>[s(a,{title:"重置密码（管理员）",type:"line"})])),default:u((()=>[s(_,{style:{padding:"10px"}},{default:u((()=>[s(C,{ref:"resetPwdForm",modelValue:G.value,"label-width":"80px"},{default:u((()=>[s(b,{required:"",label:"学号/id",name:"id"},{default:u((()=>[s(V,{trim:"both",modelValue:G.value.id,"onUpdate:modelValue":l[15]||(l[15]=e=>G.value.id=e),placeholder:"输入学号/id"},null,8,["modelValue"])])),_:1}),s(_,{style:{"margin-bottom":"5px","text-align":"center",color:"#ccc"}},{default:u((()=>[r("初始密码为123456")])),_:1})])),_:1},8,["modelValue"]),s(g,{loading:K.value,type:"primary",onClick:ne},{default:u((()=>[r("确认")])),_:1},8,["loading"])])),_:1})])),_:1})])),_:1})])),_:1})):p("",!0),1==A.value.type?(o(),d(h,{key:6,padding:"0"},{default:u((()=>[s(w,null,{default:u((()=>[s(y,{titleBorder:"none"},{title:u((()=>[s(a,{title:"批量添加学生（管理员）",type:"line"})])),default:u((()=>[s(_,{style:{padding:"10px"}},{default:u((()=>[s(g,{loading:K.value,type:"primary",onClick:l[16]||(l[16]=e=>X("form1"))},{default:u((()=>[r("确认")])),_:1},8,["loading"])])),_:1})])),_:1})])),_:1})])),_:1})):p("",!0),1==A.value.type?(o(),d(h,{key:7,padding:"0"},{default:u((()=>[s(w,null,{default:u((()=>[s(y,{titleBorder:"none"},{title:u((()=>[s(a,{title:"添加全局管理员（管理员）",type:"line"})])),default:u((()=>[s(_,{style:{padding:"10px"}},{default:u((()=>[s(C,{ref:"addStudentForm",modelValue:E.value,"label-width":"80px"},{default:u((()=>[s(b,{label:"id",name:"id"},{default:u((()=>[s(V,{trim:"both",modelValue:E.value.id,"onUpdate:modelValue":l[17]||(l[17]=e=>E.value.id=e),placeholder:"输入学号/id（留空自动生成id）"},null,8,["modelValue"])])),_:1}),s(_,{style:{"margin-bottom":"5px","text-align":"center",color:"#ccc"}},{default:u((()=>[r("初始密码为123456")])),_:1})])),_:1},8,["modelValue"]),s(g,{loading:K.value,type:"primary",onClick:ie},{default:u((()=>[r("确认")])),_:1},8,["loading"])])),_:1})])),_:1})])),_:1})])),_:1})):p("",!0),ue.value?(o(),d(F,{key:8,ref:"inputDialog",type:"dialog"},{default:u((()=>[s(q,{ref:"inputClose",mode:"input",title:ee.value.title,placeholder:ee.value.placeholder,modelValue:ee.value.value,"onUpdate:modelValue":l[18]||(l[18]=e=>ee.value.value=e),onConfirm:ae,onCancel:l[19]||(l[19]=e=>ue.value=!1)},null,8,["title","placeholder","modelValue"])])),_:1},512)):p("",!0),A.value?(o(),d(g,{key:9,loading:K.value,class:"uni-mx-5",type:"warn",onClick:Y},{default:u((()=>[r("退出登录")])),_:1},8,["loading"])):p("",!0),s(_,{class:"edgeInsetBottom"})])),_:1},8,["style"])}}},[["__scopeId","data-v-747aa09a"]]);export{S as default};
