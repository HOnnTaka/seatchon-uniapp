import{o as e,c as a,w as l,h as t,t as n,k as u,q as i,s,v as o,D as r,y as d,x as v,E as c,W as f,G as m,r as y,a as h,i as p,d as _,b as g,e as k,f as b,F as w,H as I,n as M,J as S,C,A as T,z as D,K as x,L as j,M as R}from"./index-C_Y7Ajtv.js";import{_ as $}from"./uni-section.Ctt9htVn.js";import{_ as A,o as L,b as N,f as z,d as O,r as V,e as F}from"./uni-card.DsU4cJID.js";import{_ as B}from"./uni-list-item.BrZZhRWY.js";import{_ as H,a as q,b as E,c as G}from"./uni-popup.CziwDEKg.js";function J(e,a=2){for(e+="";e.length<a;)e="0"+e;return e.slice(-a)}const K={yyyy:e=>J(e.year,4),yy:e=>J(e.year),MM:e=>J(e.month),M:e=>e.month,dd:e=>J(e.day),d:e=>e.day,hh:e=>J(e.hour),h:e=>e.hour,mm:e=>J(e.minute),m:e=>e.minute,ss:e=>J(e.second),s:e=>e.second,SSS:e=>J(e.millisecond,3),S:e=>e.millisecond};function U(e){return e instanceof Date?e:"string"==typeof e?e.indexOf("T")>-1?new Date(e):new Date(e.replace(/-/g,"/")):new Date(e)}function W(e,{locale:a="zh",threshold:l=[6e4,36e5],format:t="yyyy/MM/dd hh:mm:ss"}){if("-"===e)return e;if(!e&&0!==e)return"";const n={zh:{year:"年",month:"月",day:"天",hour:"小时",minute:"分钟",second:"秒",ago:"前",later:"后",justNow:"刚刚",soon:"马上",template:"{num}{unit}{suffix}"},en:{year:"year",month:"month",day:"day",hour:"hour",minute:"minute",second:"second",ago:"ago",later:"later",justNow:"just now",soon:"soon",template:"{num} {unit} {suffix}"}},u=n[a]||n.zh;let i,s,o=U(e),r=o.getTime()-Date.now(),d=Math.abs(r);if(d<l[0])return r<0?u.justNow:u.soon;if(d>=l[1])return function(e,a="yyyy/MM/dd hh:mm:ss"){if(!e&&0!==e)return"";const l={year:(e=U(e)).getFullYear(),month:e.getMonth()+1,day:e.getDate(),hour:e.getHours(),minute:e.getMinutes(),second:e.getSeconds(),millisecond:e.getMilliseconds()},t=/yyyy|yy|MM|M|dd|d|hh|h|mm|m|ss|s|SSS|SS|S/;let n=!0,u=a;for(;n;)n=!1,u=u.replace(t,(function(e){return n=!0,K[e](l)}));return u}(o,t);let v=u.later;r<0&&(v=u.ago,r=-r);const c=Math.floor(r/1e3),f=Math.floor(c/60),m=Math.floor(f/60),y=Math.floor(m/24),h=Math.floor(y/30),p=Math.floor(h/12);switch(!0){case p>0:i=p,s=u.year;break;case h>0:i=h,s=u.month;break;case y>0:i=y,s=u.day;break;case m>0:i=m,s=u.hour;break;case f>0:i=f,s=u.minute;break;default:i=c,s=u.second}return"en"===a&&(1===i?i="a":s+="s"),u.template.replace(/{\s*num\s*}/g,i+"").replace(/{\s*unit\s*}/g,s).replace(/{\s*suffix\s*}/g,v)}const Y=A({name:"uniDateformat",props:{date:{type:[Object,String,Number],default:()=>"-"},locale:{type:String,default:"zh"},threshold:{type:Array,default:()=>[0,0]},format:{type:String,default:"yyyy/MM/dd hh:mm:ss"},refreshRate:{type:[Number,String],default:0}},data:()=>({refreshMark:0}),computed:{dateShow(){return this.refreshMark,W(this.date,{locale:this.locale,threshold:this.threshold,format:this.format})}},watch:{refreshRate:{handler(){this.setAutoRefresh()},immediate:!0}},methods:{refresh(){this.refreshMark++},setAutoRefresh(){clearInterval(this.refreshInterval),this.refreshRate&&(this.refreshInterval=setInterval((()=>{this.refresh()}),parseInt(this.refreshRate)))}}},[["render",function(i,s,o,r,d,v){const c=u;return e(),a(c,null,{default:l((()=>[t(n(v.dateShow),1)])),_:1})}]]),P=A({__name:"detail",setup(A){const J=i().find((e=>"pages/detail/detail"===e.route)),K=s(null),U=s(null),W=s(),P=s(!1),Q=s(o("userinfo")),X=s(!1),Z=s(!0),ee=s(!1),ae=s("将使用以下信息选座：");L((async e=>{U.value=e.chartId,await ne(e.chartId),ee.value=!0,r()})),N((async()=>{Q.value=o("userinfo"),await ne(U.value)})),z((()=>{})),O((async()=>{await ne(U.value),d(),v()}));const le=c((()=>{var e;return null==(e=W.value)?void 0:e.administrators.includes(Q.value._id)})),te=c((()=>{var e;return(null==(e=W.value)?void 0:e.administrators[0])==Q.value._id})),ne=async e=>{P.value=!0;const a=f.database(),{result:l}=await a.collection("seat-chart").doc(e).get();W.value=l.data[0],m({title:W.value.title}),await ie(),P.value=!1},ue=s([]),ie=async()=>{var e,a;if(!(null==(e=W.value)?void 0:e.administrators))return"";const l=f.database(),{result:t}=await l.collection("user").where({_id:l.command.in(W.value.administrators)}).field("nickName").get(),n=null==(a=W.value)?void 0:a.administrators.map((e=>{const a=t.data.find((a=>a._id==e));if(a)return a.nickName}));ue.value=n},se=()=>{var e;if(!W.value)return!1;const a=null==(e=W.value)?void 0:e.selectableTimeRange,l=new Date((new Date).toISOString().substring(0,10)).getTime(),t=new Date(a[0]).getTime(),n=new Date(a[1]).getTime();return t<=l&&l<=n},oe=async()=>{X.value=!1,Ie.value={value:"",title:"",placeholder:""}},re=async(e=!0)=>{var a;await ne(U.value),e&&S({title:"刷新成功",icon:"success"}),K.value=W.value.seats[(null==(a=K.value)?void 0:a.index)-1]},de=async()=>{var e;Z.value=(null==(e=K.value.stuInfo)?void 0:e.id)!=Q.value._id,ae.value=Z.value?"将使用以下信息选座：":"将撤销以下选座：",X.value=!0},ve=async()=>{C({title:"加载中",mask:!0}),P.value=!0;const{result:e}=await f.callFunction({name:"select-seat",data:{chartId:U.value,seatIndex:K.value.index,userinfo:le.value?Ie.value:Q.value,isSelectSubmit:Z.value,orderId:K.value.orderId,edit:le.value}});X.value=!1,200==e.code?S({title:le.value?"修改成功":"选座成功",icon:"success"}):201==e.code?S({title:"撤销成功",icon:"success"}):S({title:e.message,icon:"error"}),re(!1)},ce=s({value:"",title:"",placeholder:""}),fe=s(!1),me=async()=>{ce.value={type:"addAdmin",title:"添加管理员(仅当前课室)",placeholder:"请输入管理员学号/id",value:""},fe.value=!0,setTimeout((()=>{J.$vm.$refs.inputDialog.open()}))},ye=async()=>{ce.value={type:"deleteAdmin",title:"删除管理员(仅当前课室)",placeholder:"请输入管理员学号/id",value:""},fe.value=!0,setTimeout((()=>{J.$vm.$refs.inputDialog.open()}))},he=async(e,a)=>{ce.value={type:e,title:"编辑"+e,placeholder:"请输入"+e,value:a},fe.value=!0,setTimeout((()=>{J.$vm.$refs.inputDialog.open()}))},pe={"姓名":"name","班级":"class","学号":"id"},_e=async e=>{console.log(ce.value);const a=e.trim();if(0===a.length)return void S({title:"内容不能为空",icon:"none"});const{type:l}=ce.value;if("addAdmin"==l)return ge(a);if("deleteAdmin"==l)return ke(a);if("学号"==l){P.value=!0,C({title:"加载中",mask:!0});const e=f.database(),{result:t}=await e.collection("user").doc(a).field("_id,name,class").get();if(console.log(t),r(),P.value=!1,0==t.data.length)return void S({title:"用户不存在",icon:"none"});Ie.value[pe[l]]=t.data[0]._id,Ie.value.name=t.data[0].name||"",Ie.value.class=t.data[0].class||""}else{if(!(await T({title:"提示",content:"单独修改姓名或班级不会同步到相应用户",confirmText:"继续"})).confirm)return;Ie.value[pe[l]]=a}},ge=async e=>{C({title:"加载中",mask:!0}),P.value=!0;const{administrators:a}=W.value;if(a.includes(e))return S({title:"该用户已是管理员",icon:"none"}),void(P.value=!1);const l=f.database(),{result:t}=await l.collection("user").doc(e).field("_id").get();if(0==t.data.length)return S({title:"用户不存在",icon:"none"}),void(P.value=!1);a.push(e),W.value.administrators=a,await l.collection("seat-chart").doc(U.value).update({administrators:a}),await ie(),P.value=!1,S({title:"添加成功",icon:"success"}),fe.value=!1},ke=async e=>{C({title:"加载中",mask:!0}),P.value=!0;const{administrators:a}=W.value;if(!a.includes(e))return S({title:"该用户不是管理员",icon:"none"}),void(P.value=!1);if(e==Q.value._id)return S({title:"不能删除自己",icon:"none"}),void(P.value=!1);const l=a.indexOf(e);a.splice(l,1);const t=f.database();await t.collection("seat-chart").doc(U.value).update({administrators:a}),await ie(),W.value.administrators=a,S({title:"删除成功",icon:"success"}),P.value=!1,fe.value=!1},be=()=>{D({url:"/pages/createSeatChart/createSeatChart?type=edit&chartId="+U.value})},we=async()=>{if(!(await T({title:"提示",content:"确定删除该课室吗？"})).confirm)return;C({title:"加载中",mask:!0});const e=f.database(),{result:a}=await e.collection("seat-chart").doc(U.value).remove();console.log(a),S({title:"删除成功",icon:"success"}),setTimeout((()=>{x()}),1e3)},Ie=s({}),Me=async()=>{Ce(!0)},Se=async()=>{Ce(!1)},Ce=async e=>{var a,l,t;Z.value=e,ae.value=e?"将修改以下选座：":"将撤销以下选座：",Ie.value={id:(null==(a=K.value.stuInfo)?void 0:a.id)||Q.value._id,name:(null==(l=K.value.stuInfo)?void 0:l.name)||Q.value.name,class:(null==(t=K.value.stuInfo)?void 0:t.class)||Q.value.class},X.value=!0},Te=e=>{console.log(e),j({data:e,showToast:!0,success:function(){d()}})};return(i,s)=>{const o=p,r=V(y("uni-section"),$),d=u,v=V(y("uni-list-item"),B),c=R,f=V(y("uni-collapse-item"),H),m=V(y("uni-collapse"),q),S=V(y("uni-card"),F),C=V(y("uni-dateformat"),Y),T=V(y("uni-popup-dialog"),E),D=V(y("uni-popup"),G);return e(),a(o,{class:"contaioner",style:h([{transition:"all 1s ease",opacity:"0"},null!=W.value?"transition: all .5s ease; opacity: 1":""])},{default:l((()=>[le.value?(e(),a(o,{key:0,class:"admin-tag"},{default:l((()=>[t("管理员")])),_:1})):_("",!0),g(S,{padding:"0"},{default:l((()=>[g(m,null,{default:l((()=>[g(f,{open:null!=W.value&&!P.value,titleBorder:"none"},{title:l((()=>[g(r,{title:"课室信息",type:"line"})])),default:l((()=>[g(v,{title:"课室",onLongpress:s[0]||(s[0]=e=>{var a;return Te(null==(a=W.value)?void 0:a.title)})},{footer:l((()=>[g(d,null,{default:l((()=>{var e;return[t(n(null==(e=W.value)?void 0:e.title),1)]})),_:1})])),_:1}),g(v,{title:"备注",onLongpress:s[1]||(s[1]=e=>{var a;return Te(null==(a=W.value)?void 0:a.note)})},{footer:l((()=>[g(d,null,{default:l((()=>{var e;return[t(n(null==(e=W.value)?void 0:e.note),1)]})),_:1})])),_:1}),g(v,{title:"选座时间",onLongpress:s[2]||(s[2]=e=>{var a;return Te(null==(a=W.value)?void 0:a.selectableTimeRange.join(" 至 "))})},{footer:l((()=>[g(d,{"user-select":""},{default:l((()=>{var e;return[t(n(null==(e=W.value)?void 0:e.selectableTimeRange.join(" 至 ")),1)]})),_:1})])),_:1}),g(v,{title:"生效时间",onLongpress:s[3]||(s[3]=e=>{var a;return Te(null==(a=W.value)?void 0:a.effectiveTimeRange.join(" 至 "))})},{footer:l((()=>[g(d,null,{default:l((()=>{var e;return[t(n(null==(e=W.value)?void 0:e.effectiveTimeRange.join(" 至 ")),1)]})),_:1})])),_:1}),le.value?(e(),a(o,{key:0,class:"edit-chart-btns"},{default:l((()=>[g(c,{class:"btn",onClick:be,type:"primary",loading:P.value},{default:l((()=>[t(" 编辑课室 ")])),_:1},8,["loading"]),te.value?(e(),a(c,{key:0,class:"btn",onClick:we,type:"warn",loading:P.value},{default:l((()=>[t(" 删除课室 ")])),_:1},8,["loading"])):_("",!0)])),_:1})):_("",!0)])),_:1},8,["open"])])),_:1})])),_:1}),g(S,{padding:"0"},{default:l((()=>[g(m,null,{default:l((()=>[g(f,{open:null!=W.value&&!P.value,titleBorder:"none"},{title:l((()=>[g(r,{title:"课室管理员",type:"line"})])),default:l((()=>{var u;return[(e(!0),k(w,null,b(null==(u=W.value)?void 0:u.administrators,((u,i)=>(e(),a(v,{class:"admin-item",ellipsis:"1",title:ue.value[i],key:i},{header:l((()=>[0==i?(e(),a(o,{key:0,class:"admin-item-tag"},{default:l((()=>[t("主")])),_:1})):_("",!0)])),footer:l((()=>[g(d,{onLongpress:e=>Te(u),"user-select":""},{default:l((()=>[t(n(u),1)])),_:2},1032,["onLongpress"])])),_:2},1032,["title"])))),128)),te.value?(e(),a(o,{key:0,class:"edit-chart-btns"},{default:l((()=>[g(c,{class:"btn",onClick:me,type:"primary",loading:P.value},{default:l((()=>[t("添加管理员")])),_:1},8,["loading"]),g(c,{class:"btn",onClick:ye,type:"warn",loading:P.value},{default:l((()=>[t("删除管理员")])),_:1},8,["loading"])])),_:1})):_("",!0)]})),_:1},8,["open"])])),_:1})])),_:1}),g(S,{padding:"0"},{title:l((()=>[g(r,{title:"座位表",type:"line"})])),default:l((()=>{var u,i;return[g(o,{class:"seatTable",style:h(`--col:${null==(u=W.value)?void 0:u.col};--row:${null==(i=W.value)?void 0:i.row};`)},{default:l((()=>{var u;return[(e(!0),k(w,null,b(null==(u=W.value)?void 0:u.seats,((u,i)=>{var s,r,v;return e(),a(o,{key:i,class:M(["seat",{hide:2==u.status,selected:u.index==(null==(s=K.value)?void 0:s.index)}]),style:h((null==(r=null==u?void 0:u.stuInfo)?void 0:r.id)!=Q.value._id?`background-image:url(${null==(v=u.stuInfo)?void 0:v.avatar});`:"background:#333;"),onClick:()=>K.value=u},{default:l((()=>[g(d,null,{default:l((()=>{var e;return[t(n(u.stuInfo?(null==(e=null==u?void 0:u.stuInfo)?void 0:e.id)!=Q.value._id?"":"你":"空"),1)]})),_:2},1024)])),_:2},1032,["class","style","onClick"])})),128))]})),_:1},8,["style"]),g(c,{class:"refresh-btn",onClick:re,type:"default",size:"mini",loading:P.value},{default:l((()=>[t(" 刷新 ")])),_:1},8,["loading"])]})),_:1}),K.value?(e(),a(S,{key:1,class:"order-card",padding:"0"},{title:l((()=>[g(r,{title:"座位信息",type:"line"})])),default:l((()=>[g(o,{class:"detail"},{default:l((()=>{var u,i;return[g(v,{title:"座位"},{footer:l((()=>[g(d,null,{default:l((()=>{var e,a;return[t("第"+n(null==(e=K.value)?void 0:e.x)+"列 第"+n(null==(a=K.value)?void 0:a.y)+"行",1)]})),_:1})])),_:1}),(null==(u=K.value)?void 0:u.stuInfo)&&(W.value.stuInfoVisible||1==Q.value.type)?(e(),a(o,{key:0},{default:l((()=>[g(v,{title:"姓名"},{footer:l((()=>[g(d,null,{default:l((()=>{var e,a;return[t(n(null==(a=null==(e=K.value)?void 0:e.stuInfo)?void 0:a.name),1)]})),_:1})])),_:1}),g(v,{title:"学号"},{footer:l((()=>[g(d,null,{default:l((()=>{var e,a;return[t(n(null==(a=null==(e=K.value)?void 0:e.stuInfo)?void 0:a.id),1)]})),_:1})])),_:1}),g(v,{title:"班级"},{footer:l((()=>[g(d,null,{default:l((()=>{var e,a;return[t(n(null==(a=null==(e=K.value)?void 0:e.stuInfo)?void 0:a.class),1)]})),_:1})])),_:1})])),_:1})):_("",!0),(null==(i=K.value)?void 0:i.selectTime)?(e(),a(v,{key:1,title:"选择时间"},{footer:l((()=>{var e;return[g(C,{date:new Date(null==(e=K.value)?void 0:e.selectTime)-3e4,format:"M月d日 h时m分",threshold:[0,36e5]},null,8,["date"])]})),_:1})):_("",!0)]})),_:1})])),_:1})):_("",!0),le.value?(e(),a(o,{key:2,class:"btns"},{default:l((()=>{var e;return[g(c,{class:"btn",disabled:!K.value,onClick:Me,type:"primary",loading:P.value},{default:l((()=>[t(" 编辑选座 ")])),_:1},8,["disabled","loading"]),g(c,{class:"btn",disabled:3!=(null==(e=K.value)?void 0:e.status),onClick:Se,type:"warn",loading:P.value},{default:l((()=>[t(" 删除选座 ")])),_:1},8,["disabled","loading"])]})),_:1})):(e(),a(o,{key:3,class:"btns"},{default:l((()=>{var u,i,s,o,r;return[se()?(e(),a(c,{key:0,class:"btn",onClick:de,disabled:3==(null==(u=K.value)?void 0:u.status)&&(null==(s=null==(i=K.value)?void 0:i.stuInfo)?void 0:s.id)!=Q.value._id||!K.value,type:(null==(r=null==(o=K.value)?void 0:o.stuInfo)?void 0:r.id)==Q.value._id?"warn":"primary",loading:P.value},{default:l((()=>{var e,a,l;return[t(n((null==(a=null==(e=K.value)?void 0:e.stuInfo)?void 0:a.id)==Q.value._id?"撤销选座":3==(null==(l=K.value)?void 0:l.status)?"已被选择":"选择座位"),1)]})),_:1},8,["disabled","type","loading"])):_("",!0),se()?_("",!0):(e(),a(c,{key:1,class:"btn",disabled:""},{default:l((()=>[t("未开放或选座时间已过")])),_:1}))]})),_:1})),g(o,{onClick:oe,class:M(["drawer",{hide:!X.value}])},{default:l((()=>[g(o,{onClick:s[7]||(s[7]=I((()=>{}),["stop","prevent"])),class:"drawer-content"},{default:l((()=>[g(o,{class:"title"},{default:l((()=>[t(n(ae.value),1)])),_:1}),g(S,{class:"roomInfo"},{title:l((()=>[g(r,{title:"课室信息",type:"line"})])),default:l((()=>[g(v,{title:"课室"},{footer:l((()=>[g(d,null,{default:l((()=>{var e;return[t(n(null==(e=W.value)?void 0:e.title),1)]})),_:1})])),_:1}),g(v,{title:"座位"},{footer:l((()=>[g(d,null,{default:l((()=>{var e,a;return[t("第"+n(null==(e=K.value)?void 0:e.x)+"列 第"+n(null==(a=K.value)?void 0:a.y)+"行",1)]})),_:1})])),_:1}),g(v,{title:"生效时间"},{footer:l((()=>[g(d,null,{default:l((()=>{var e;return[t(n(null==(e=W.value)?void 0:e.effectiveTimeRange.join(" 至 ")),1)]})),_:1})])),_:1})])),_:1}),g(S,{padding:"0"},{title:l((()=>[g(r,{title:"学生信息",type:"line"})])),default:l((()=>[g(v,{title:"学号",onClick:s[4]||(s[4]=e=>he("学号",Ie.value.id)),link:le.value&&Z.value},{footer:l((()=>[g(d,null,{default:l((()=>[t(n(le.value?Ie.value.id:Q.value._id),1)])),_:1})])),_:1},8,["link"]),g(v,{title:"姓名",onClick:s[5]||(s[5]=e=>he("姓名",Ie.value.name)),link:le.value&&Z.value},{footer:l((()=>[g(d,null,{default:l((()=>[t(n(le.value?Ie.value.name:Q.value.name),1)])),_:1})])),_:1},8,["link"]),g(v,{title:"班级",onClick:s[6]||(s[6]=e=>he("班级",Ie.value.class)),link:le.value&&Z.value},{footer:l((()=>[g(d,null,{default:l((()=>[t(n(le.value?Ie.value.class:Q.value.class),1)])),_:1})])),_:1},8,["link"])])),_:1}),g(c,{onClick:ve,type:Z.value?"primary":"warn",loading:P.value},{default:l((()=>[t(" 确认 ")])),_:1},8,["type","loading"])])),_:1})])),_:1},8,["class"]),fe.value?(e(),a(D,{key:4,ref:"inputDialog",type:"dialog"},{default:l((()=>[g(T,{ref:"inputClose",mode:"input",title:ce.value.title,placeholder:ce.value.placeholder,modelValue:ce.value.value,"onUpdate:modelValue":s[8]||(s[8]=e=>ce.value.value=e),onConfirm:_e,onCancel:s[9]||(s[9]=e=>fe.value=!1)},null,8,["title","placeholder","modelValue"])])),_:1},512)):_("",!0)])),_:1},8,["style"])}}},[["__scopeId","data-v-c3ec4307"]]);export{P as default};
